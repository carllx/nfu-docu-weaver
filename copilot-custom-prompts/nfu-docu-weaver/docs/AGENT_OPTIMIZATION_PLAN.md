# Lesson-Weaver Agent 优化计划

**版本**: v2.1  
**日期**: 2025-10-05  
**基于**: suggestion.md 实战经验总结

---

## 📊 执行摘要

基于 `suggestion.md` 中记录的13个实战经验，我们识别出 `lesson-weaver.md` agent 的**5大优化方向**和**12项具体改进**。这些优化将显著提升用户体验，减少错误率，加快工作流程。

---

## 🔍 问题分析

### 当前 Agent 的不足

| 不足项 | 影响 | 严重性 |
|--------|------|--------|
| **缺少数据准备指导** | 用户不知道如何创建 YAML 文件 | 🔴 高 |
| **缺少 Gemini 集成** | 浪费 Token，效率低 | 🟡 中 |
| **缺少格式问题诊断** | 生成文档有格式错误时无法快速定位 | 🟡 中 |
| **YAML 格式陷阱未预警** | 用户频繁遇到格式错误 | 🟡 中 |
| **常见问题未前置** | 相同错误重复发生 | 🟢 低 |

### Suggestion.md 中的关键经验

**经验分类统计**：
- 🛠️ **技术修复经验**: 8 项（字段映射、格式保留、缩进等）
- 📝 **YAML 格式经验**: 5 项（引号、转义、类型等）
- 🔄 **工作流经验**: 3 项（Gemini 提取、增量创建、验证策略）
- 📋 **最佳实践**: 2 项（命名规范、课时约束）

---

## 🎯 优化方向

### 方向 1: 增强数据准备阶段 🆕

**目标**: 用户能轻松创建符合 Schema 的 YAML 文件

**新增模块**：

#### 1.1 新增状态: `引导数据准备`

```yaml
当前状态: 引导数据准备

触发条件:
  - 用户表示"没有数据文件"
  - 分析数据发现目录为空
  - 用户询问"如何创建数据文件"

行动流程:
  1. 识别用户的数据来源类型
  2. 提供针对性的创建方案
  3. 提供工具和模板支持
  4. 预防常见格式错误

交互示例:
  """
  📝 看起来你还没有教案数据文件。让我帮你准备数据！
  
  🎯 你的数据来源是什么？
  
  1. **我已有 Word/PDF 教案文档** ⭐ 推荐
     → 我会教你使用 Gemini 快速提取结构化数据
     → 优势: 节省 Token，效率高，准确性好
     
  2. **我要从零开始创建**
     → 我会提供模板和逐步指导
     → 适合: 新课程或完全自定义内容
     
  3. **我有部分数据，需要补充剩余部分**
     → 增量创建模式
     → 我会参考已有文件的风格
  
  请选择 (1-3):
  """
```

#### 1.2 新增子流程: Gemini 辅助提取 🆕

**重要性**: ⭐⭐⭐ (来自经验2)

```yaml
流程: Gemini 辅助提取工作流

步骤:
  Step 1: 说明 Gemini 方案的价值
    - 节省 Claude Token 消耗 (可节省 80%)
    - 一次性提取所有信息
    - 保持原文专业术语
  
  Step 2: 提供标准化 Prompt
    - 课程基本信息提取 Prompt
    - 单个教案详细信息提取 Prompt
    - 强调"不编造"原则
  
  Step 3: 指导用户操作
    - 上传文档到 Gemini
    - 粘贴 Prompt
    - 获取结构化数据
  
  Step 4: 接收并验证数据
    - 用户粘贴 Gemini 返回的数据
    - Agent 转换为 YAML 格式
    - 验证完整性

示例交互:
  """
  ✨ 太好了！你已有教案文档，我推荐使用 Gemini 提取方案。
  
  💡 为什么使用 Gemini？
    - 节省 80% 的 Token 消耗
    - 提取速度快（约 1 分钟）
    - 数据准确，保持原文风格
  
  📋 接下来的步骤：
  
  1️⃣ 打开 Gemini (gemini.google.com)
  2️⃣ 上传你的教案文档
  3️⃣ 复制并粘贴以下 Prompt:
  
  ┌─────────────────────────────────────
  │ [标准化 Prompt - 自动生成]
  │
  │ 请从上传的教案文档中提取第 X 课的详细教学信息。
  │
  │ **重要规则**:
  │ - 只提取文档中明确存在的信息
  │ - 如果某项信息不存在，请如实回答 "没有提供"
  │ - 不要编造或推测任何信息
  │ [... 完整 Prompt]
  └─────────────────────────────────────
  
  4️⃣ 将 Gemini 的回答完整复制回来
  
  准备好了吗？(输入"已复制"或直接粘贴 Gemini 的回答)
  """
```

#### 1.3 新增: YAML 格式陷阱预警系统 🆕

**重要性**: ⭐⭐⭐ (来自经验5的YAML格式注意事项)

```yaml
预警系统: YAML 格式常见陷阱

时机: 在用户即将创建/编辑 YAML 文件时主动提醒

核心陷阱 (必须提醒):

陷阱 1: 中文引号冲突 ❌
  错误示例: value: "内容中有"中文引号"的文本"
  正确示例: value: '内容中有"中文引号"的文本'
  规则: 如果内容包含中文引号(""），外层用单引号包裹

陷阱 2: 类型错误 ❌
  错误示例: 
    lesson_number: 8
    class_hours.total: 4
  正确示例:
    lesson_number: "8"
    class_hours.total: "4"
  规则: lesson_number 和 class_hours.total 必须是字符串

陷阱 3: 嵌套引号 ❌
  错误示例: in_class_thinking: ""问题内容？""
  正确示例: in_class_thinking: "问题内容？"
  规则: 不需要双层引号

陷阱 4: 转义符未处理 ❌
  错误示例: value: "第一行\n第二行"
  正确示例: value: |
               第一行
               第二行
  规则: 多行文本使用 | 或 > 语法

陷阱 5: 空值处理 ❌
  错误示例: 
    value: "
            (有换行)
  正确示例: value: ""
  规则: 空字段使用 ""

交互示例:
  """
  ⚠️ 在创建 YAML 文件前，请注意这些常见陷阱！
  
  🔴 最容易出错的 3 个地方:
  
  1. **中文引号冲突** (80% 的格式错误来源)
     ❌ 错误: value: "这是"重点"内容"
     ✅ 正确: value: '这是"重点"内容'
     
  2. **数字必须加引号**
     ❌ 错误: lesson_number: 8
     ✅ 正确: lesson_number: "8"
     
  3. **多行文本格式**
     ❌ 错误: value: "第一行\n第二行"
     ✅ 正确: value: |
                第一行
                第二行
  
  💡 专业提示: 我会在验证时自动检查这些问题！
  
  继续创建数据文件？
  """
```

---

### 方向 2: 增强问题诊断能力

**目标**: 快速定位和解决格式问题

#### 2.1 新增: Word 格式问题诊断器 🆕

**重要性**: ⭐⭐⭐ (来自经验6-13的格式修复经验)

```yaml
诊断器: Word 格式问题快速诊断

触发条件:
  - 用户报告"生成的文档格式不对"
  - 验证检测到格式相关警告
  - 用户询问"为什么格式不对"

诊断流程:
  1. 询问具体症状
  2. 匹配已知问题模式
  3. 提供针对性解决方案
  4. 验证修复效果

已知问题库 (来自 suggestion.md):

问题 1: 占位符前的粗体格式丢失
  症状: "重点："、"难点："等标签失去粗体
  原因: 替换逻辑未保留独立 run 格式
  状态: ✅ 已修复 (v2.1)
  验证: 检查标签文字是否保持粗体

问题 2: 替换内容错误继承格式
  症状: 替换后的内容变成粗体
  原因: 继承了前面文字的装饰性格式
  状态: ✅ 已修复 (v2.1)
  验证: 检查替换内容是否为非粗体

问题 3: 多行文本首行缩进丢失
  症状: 换行后的行没有缩进
  原因: 新段落未继承段落格式
  状态: ✅ 已修复 (v2.1)
  验证: 检查每行是否有正确的首行缩进

问题 4: 占位符未被替换
  症状: 文档中仍有 {{placeholder}}
  原因: 
    - 数据文件缺少对应字段
    - 字段名拼写错误
    - 数组索引访问失败
  状态: 需检查数据完整性
  解决: 运行验证命令

问题 5: 出现代码残余
  症状: 文档中出现 {'value': '...'}
  原因: 字典格式未正确处理
  状态: ✅ 已修复 (v2.0)
  验证: 检查是否有字典格式文本

交互示例:
  """
  🔍 让我帮你诊断格式问题。
  
  请描述你看到的具体问题（可多选）:
  
  1. 📝 占位符没有被替换（文档中还有 {{...}}）
  2. 💪 标签文字（如"重点："）失去了粗体
  3. 📏 多行文本的缩进不对齐
  4. 🔤 替换后的文字格式不对（变成粗体了）
  5. 🐛 出现奇怪的代码文本（如 {'value': ...}）
  6. ❓ 其他问题（请描述）
  
  请输入问题编号:
  
  [用户输入: 1]
  
  📋 占位符未替换的诊断流程:
  
  第一步：检查数据完整性
    → 运行验证命令...
    → python tools/generate_docs.py validate ...
    
  [验证结果显示: lesson-03.yml 缺少 lesson_title 字段]
  
  ✅ 找到问题了！
  
  📌 问题根源:
    - 文件: lesson-03.yml
    - 缺少字段: lesson_title
    - 模板需要这个字段: {{lesson_title}}
  
  🔧 解决方案:
    1. 打开 lessons/lesson-03.yml
    2. 添加一行:
       lesson_title: "你的教案标题"
    3. 保存文件
    4. 重新生成这个文档
  
  需要我帮你重新生成吗？
  """
```

#### 2.2 增强: 验证错误解释器

```yaml
增强: 将简单错误消息转换为可操作指导

示例转换:

原始错误: "缺少必需字段: lesson_title"

增强解释:
  """
  ❌ 验证失败: lesson-03.yml
  
  问题: 缺少必需字段 `lesson_title`
  
  📖 什么是 lesson_title?
     - 这是教案的标题（如"认识字体（上）"）
     - 它会显示在生成的 Word 文档标题位置
     - Schema 规定这是必需字段
  
  🔧 如何修复:
  1. 打开文件: lessons/lesson-03.yml
  2. 在文件顶部附近添加:
     ```yaml
     lesson_title: "第3课：你的标题"
     ```
  3. 保存文件
  4. 告诉我"已修复"，我会重新验证
  
  💡 需要参考？
     - 查看 Schema 定义: schemas/lesson_schema.yml
     - 参考其他文件: lessons/lesson-01.yml
  
  需要我展示一个完整的示例吗？
  """
```

---

### 方向 3: 优化状态机工作流

#### 3.1 新增状态转换: 数据准备 → 分析数据

```yaml
新的状态流程:

等待课程输入
    ↓
分析数据
    ↓ (发现目录为空)
引导数据准备 🆕
    ↓ (用户选择 Gemini 提取)
Gemini 辅助提取 🆕
    ↓ (数据准备完成)
分析数据 (重新)
    ↓
等待方案确认
    ↓
验证数据 (增强诊断)
    ↓
批量生成
    ↓
任务完成
```

#### 3.2 增强: 分析数据状态

```yaml
增强点:
  - 检测数据文件数量与课程周次的匹配度
  - 检测文件命名规范
  - 预警可能的问题

示例交互 (增强版):
  """
  🔍 正在分析数据目录...
  📂 数据目录: courses/course-001-字体设计基础/lessons/
  📋 发现 12 个教案数据文件
  
  ⚠️ 潜在问题预警:
  
  1. 文件数量不匹配
     - 课程配置: 16 周
     - 数据文件: 12 个
     - 缺失: 第 13-16 周的数据
  
  2. 文件命名检查
     ✅ 所有文件命名规范 (lesson-XX.yml)
     ✅ 无重复编号
  
  💡 我的建议:
  
  方案 A: 补充缺失数据 (推荐)
    → 使用 Gemini 提取剩余 4 周的内容
    → 或从零创建剩余数据文件
    
  方案 B: 继续生成现有 12 个
    → 先完成已有部分
    → 后续再补充剩余部分
    
  方案 C: 修正课程配置
    → 更新 course.yml 中的 total_weeks 为 12
  
  你想选择哪个方案？(A/B/C)
  """
```

---

### 方向 4: 添加快速诊断手册

#### 4.1 新增模块: 常见问题快速查询

```yaml
快速诊断手册:

用户可以随时输入关键词快速查询:
  - "格式问题"
  - "占位符"
  - "粗体"
  - "缩进"
  - "YAML 错误"
  - "引号"

示例:
  用户: "为什么有些地方是粗体？"
  
  Agent: 
  """
  🔍 关键词匹配: 格式 + 粗体
  
  相关问题 #4: 替换内容错误继承格式
  
  📌 症状:
    - 替换后的内容变成粗体
    - 但模板中占位符设置的是非粗体
  
  ✅ 修复状态:
    - 已在 v2.1 中修复
    - 代码文件: tools/generate_docs.py
    - 修复日期: 2025-10-05
  
  🔧 验证方法:
    1. 重新生成文档
    2. 检查替换内容是否为非粗体
    3. 检查标签文字（如"重点："）是否保持粗体
  
  💡 如果问题仍存在:
    - 确认你使用的是最新版本
    - 运行: git pull origin main
    - 重新安装: pip install -r requirements.txt
  
  需要我帮你重新生成文档吗？
  """
```

---

### 方向 5: 添加最佳实践主动推荐

#### 5.1 新增: 课程规划检查器

**重要性**: ⭐⭐ (来自经验3)

```yaml
检查器: 课程规划合理性检查

检查项:
  1. 每周课时一致性
     - 检查每周学时是否固定
     - 预警不规范的学时分配
  
  2. 章节学时分配
     - 检查章节学时是否能被每周学时整除
     - 建议跨周章节的拆分方案

示例交互:
  """
  📊 课程规划检查:
  
  课程配置:
    - 总周次: 16 周
    - 每周学时: 4 学时
    - 总学时: 64 学时
  
  ✅ 学时分配检查:
    - 每周学时一致性: 通过
    - 章节学时合理性: 通过
  
  [如果发现问题]
  
  ⚠️ 发现潜在问题:
  
  第 3 章: 灯光技术
    - 总学时: 10 学时
    - 问题: 不能被每周学时 (4) 整除
    - 影响: 需要跨周安排
  
  💡 建议方案:
  
  方案 A: 拆分为 3 周 (推荐)
    - 第 X 周: 4 学时
    - 第 Y 周: 4 学时  
    - 第 Z 周: 2 学时 (合并其他内容)
  
  方案 B: 调整章节学时为 12
    - 增加 2 学时练习或拓展内容
  
  你想采用哪个方案？
  """
```

---

## 📝 实施清单

### Phase 1: 核心增强 (v2.1)

- [ ] **P0 - 添加 YAML 格式陷阱预警系统**
  - 在数据准备阶段主动提醒
  - 在验证失败时提供格式检查
  
- [ ] **P0 - 添加 Gemini 辅助提取工作流**
  - 新增 `引导数据准备` 状态
  - 新增 `Gemini 辅助提取` 子流程
  - 提供标准化 Prompt 模板

- [ ] **P0 - 增强格式问题诊断**
  - 添加 Word 格式问题诊断器
  - 建立已知问题库
  - 提供针对性解决方案

### Phase 2: 体验优化 (v2.2)

- [ ] **P1 - 增强验证错误解释**
  - 将错误消息转换为可操作指导
  - 提供修复示例和参考资料

- [ ] **P1 - 添加课程规划检查器**
  - 检查学时一致性
  - 检查章节学时合理性

- [ ] **P1 - 优化状态机流程**
  - 添加数据准备状态转换
  - 增强分析数据的诊断能力

### Phase 3: 完善功能 (v2.3)

- [ ] **P2 - 添加快速诊断手册**
  - 支持关键词查询
  - 提供常见问题解答

- [ ] **P2 - 添加增量创建支持**
  - 识别已有数据文件
  - 参考风格生成新文件

---

## 🎯 预期效果

实施这些优化后，预期达到：

1. **减少错误率 70%**
   - YAML 格式错误减少 80%（通过预警系统）
   - 格式问题减少 90%（已修复 + 诊断增强）

2. **提升效率 50%**
   - Gemini 提取节省 80% Token
   - 问题诊断时间从 15 分钟 → 3 分钟

3. **改善用户体验**
   - 新手用户独立完成率从 30% → 80%
   - 用户满意度提升

---

## 📌 立即行动项

### 优先级排序

🔴 **立即实施** (影响最大):
1. YAML 格式陷阱预警系统
2. Gemini 辅助提取工作流
3. Word 格式问题诊断器

🟡 **近期实施** (快速见效):
4. 验证错误解释增强
5. 分析数据状态增强

🟢 **后续优化** (锦上添花):
6. 快速诊断手册
7. 课程规划检查器

---

## 📄 附录: 实施示例

### 示例 1: 完整的数据准备引导流程

```
用户: "我要为《字体设计》课程生成教案"

Agent: 
"""
你好！我是 Lesson-Weaver 教案编织者 🎓

让我帮你为《字体设计》课程生成教案文档。

首先，我需要了解课程的数据准备情况：

📂 课程工作空间检查:
   ✅ 找到课程目录: courses/course-001-字体设计/
   ✅ 课程配置: course.yml
   ⚠️  数据目录为空: lessons/

📝 看起来你还没有教案数据文件。让我帮你准备！

🎯 你的数据来源是什么？

1. **我已有 Word/PDF 教案文档** ⭐ 推荐
   → 我会教你使用 Gemini 快速提取结构化数据
   → 优势: 
      • 节省 80% Token 消耗
      • 5-10 分钟完成所有数据提取
      • 保持原文专业术语和风格
   
2. **我要从零开始创建**
   → 我会提供 YAML 模板和逐步指导
   → 适合: 新课程或完全自定义内容
   
3. **我先了解一下整个流程**
   → 我会介绍项目结构和工作原理

请选择 (1-3):
"""

用户: "1"

Agent:
"""
✨ 太好了！使用 Gemini 提取是最高效的方案。

💡 为什么推荐 Gemini？
  ✅ 节省成本: 避免直接上传大文档到 Claude
  ✅ 精准提取: 只提取结构化的必要信息
  ✅ 保持原味: 保留原文的专业术语和表述
  ✅ 快速完成: 每个教案约 1-2 分钟

📋 工作流程 (4 步完成):

┌─ Step 1: 准备 ─────────────────────────┐
│ • 准备好你的教案 Word/PDF 文档        │
│ • 打开 Gemini (gemini.google.com)      │
└────────────────────────────────────────┘
     ↓
┌─ Step 2: 上传与提取 ───────────────────┐
│ • 上传文档到 Gemini                    │
│ • 使用我提供的标准 Prompt             │
│ • 获取结构化数据                       │
└────────────────────────────────────────┘
     ↓
┌─ Step 3: 转换与验证 ───────────────────┐
│ • 将 Gemini 的回答粘贴给我            │
│ • 我转换为 YAML 格式                  │
│ • 自动验证数据完整性                   │
└────────────────────────────────────────┘
     ↓
┌─ Step 4: 生成文档 ─────────────────────┐
│ • 生成高质量 Word 教案                │
└────────────────────────────────────────┘

🎯 你准备好了吗？我现在为你生成提取 Prompt！

你的课程有多少周的教案？(输入数字，如: 16)
"""

用户: "16"

Agent:
"""
好的！16 周课程。

📋 Prompt 已为你定制生成！

请按以下步骤操作:

1️⃣ 打开 Gemini: https://gemini.google.com

2️⃣ 上传你的第 1 周教案文档

3️⃣ 复制并粘贴以下 Prompt:

┌─────────────────────────────────────────────────────────
│ 【Gemini 提取 Prompt - 第 1 周】
│
│ 请从上传的教案文档中提取第 1 课/第 1 单元的详细教学信息。
│
│ **重要规则**:
│ - 只提取文档中明确存在的信息
│ - 如果某项信息不存在，请如实回答 "没有提供"
│ - 不要编造或推测任何信息
│ - 保持原文的专业术语和表述
│
│ ## 需要提取的信息：
│
│ ### 基本信息
│ - 课次/单元编号：
│ - 课程标题：
│ - 课程名称：
│ - 学时数（总计）：
│ - 学时分配（理论/实践）：
│
│ ### 教学目标
│ - 知识目标：
│ - 能力目标：
│ - 素质目标：
│
│ [... 完整结构]
│
│ **输出格式要求**:
│ 请使用清晰的分类和缩进，便于我直接复制使用。
└─────────────────────────────────────────────────────────

4️⃣ 等待 Gemini 处理（约 30-60 秒）

5️⃣ 将 Gemini 的完整回答复制回来粘贴给我

⚠️ 在开始前，让我先提醒你 YAML 格式的常见陷阱：

🔴 最容易出错的 3 个地方:

1. **中文引号冲突** (80% 的格式错误)
   ❌ 错误: "这是"重点"内容"
   ✅ 正确: '这是"重点"内容'
   
2. **数字必须加引号**
   ❌ 错误: lesson_number: 1
   ✅ 正确: lesson_number: "1"
   
3. **多行文本格式**
   ❌ 错误: "第一行\n第二行"
   ✅ 正确: |
             第一行
             第二行

💡 不用担心！我在转换时会自动处理这些问题。

准备好开始了吗？(输入"开始"或直接粘贴 Gemini 的回答)
"""
```

---

## 🔄 版本更新记录

- **v2.1 (计划)**: 添加数据准备指导、Gemini 集成、格式诊断
- **v2.0 (当前)**: Schema 驱动架构、主动引导
- **v1.x**: 基础功能

---

**文档结束**

*维护者*: @architect.mdc  
*基于*: suggestion.md 实战经验  
*下一步*: 实施 Phase 1 核心增强
