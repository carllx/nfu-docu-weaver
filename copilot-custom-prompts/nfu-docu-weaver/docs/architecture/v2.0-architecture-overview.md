# Docu-Weaver v2.0 架构概览

**文档版本**: v2.0  
**最后更新**: 2025-10-05  
**状态**: ✅ Current  
**维护者**: @architect.mdc

---

## 📋 目录

- [1. 架构愿景](#1-架构愿景)
- [2. 核心设计原则](#2-核心设计原则)
- [3. 系统架构图](#3-系统架构图)
- [4. 三层分离架构](#4-三层分离架构)
- [5. 核心组件](#5-核心组件)
- [6. 技术栈](#6-技术栈)
- [7. 工作流程](#7-工作流程)
- [8. 版本演进](#8-版本演进)
- [9. 相关文档](#9-相关文档)

---

## 1. 架构愿景

### 1.1 设计目标

Docu-Weaver v2.0 是一个 **Schema-Driven**、**Agent-Guided** 的教学文档自动化生成系统，旨在实现：

- 🎯 **三层完全分离**: Schema / Template / Data 独立演进
- 🤖 **AI主动引导**: Agent不仅生成数据，更引导工作流
- 📋 **Schema驱动**: 数据契约作为单一事实来源
- 🔄 **向后兼容**: 平滑升级路径，保护既有投资

### 1.2 核心价值

| 价值点 | v1.x | v2.0 | 提升 |
|--------|------|------|------|
| **数据一致性** | 人工保障 | Schema自动验证 | ⬆️ 90% |
| **工作流引导** | 被动响应 | Agent主动引导 | 🆕 新能力 |
| **配置管理** | 分散在多处 | Course级别统一 | ⬆️ 100% |
| **扩展性** | 模板耦合 | 三层独立 | ⬆️ 80% |

---

## 2. 核心设计原则

### 2.1 Schema-Driven (Schema驱动)

```
Schema = Single Source of Truth
```

**核心理念**:
- Schema定义数据契约，是系统的基石
- 所有组件（AI、验证、生成）都基于Schema工作
- Schema版本化管理，确保兼容性

**实践**:
```yaml
# schemas/lesson_schema.yml
lesson:
  title: 
    type: string
    required: true
  objectives:
    type: list
    required: true
```

### 2.2 Three-Layer Separation (三层分离)

```
Schema ≠ Template ≠ Data
```

**分离原则**:
1. **Schema层**: 定义"什么数据"（数据契约）
2. **Template层**: 定义"如何呈现"（排版样式）
3. **Data层**: 定义"具体内容"（实际数据）

**优势**:
- ✅ 各层独立演进
- ✅ 复用性最大化
- ✅ 维护成本最低

### 2.3 Agent-Guided (Agent引导)

```
Agent = Guide + Generator
```

**双重角色**:
1. **工作流引导**: 主动询问、状态追踪、决策建议
2. **数据生成**: 基于Schema生成规范化数据

---

## 3. 系统架构图

### 3.1 宏观架构

```
┌─────────────────────────────────────────────────────────┐
│                    Docu-Weaver v2.0                      │
│                   Document Generation System              │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                     Layer 1: Schema                      │
│                    (Data Contract)                       │
├─────────────────────────────────────────────────────────┤
│  course_schema.yml   lesson_schema.yml   outline_schema  │
│  cover_schema.yml                                        │
└────────────────┬────────────────────────────────────────┘
                 │ 定义数据契约
                 │
┌────────────────┴────────────────────────────────────────┐
│                    Layer 2: Template                     │
│                   (Presentation)                         │
├─────────────────────────────────────────────────────────┤
│  templates/                                              │
│  ├── lesson/lesson.docx                                 │
│  ├── cover/cover.docx                                   │
│  └── outline/                                            │
└────────────────┬────────────────────────────────────────┘
                 │ 应用模板
                 │
┌────────────────┴────────────────────────────────────────┐
│                     Layer 3: Data                        │
│                    (Content)                             │
├─────────────────────────────────────────────────────────┤
│  courses/                                                │
│  └── course-XXX/                                        │
│      ├── course.yml        ← Course配置 (v2.0新增)      │
│      ├── lessons/*.yml     ← Lesson数据                 │
│      ├── outline/*.yml     ← Outline数据                │
│      └── cover/*.yml       ← Cover数据                  │
└────────────────┬────────────────────────────────────────┘
                 │
┌────────────────┴────────────────────────────────────────┐
│                    Cross-Layer Components                │
├─────────────────────────────────────────────────────────┤
│  🤖 Agent (Lesson-Weaver)   📋 Validator   🔧 Generator │
│  🛠️  Tools (course_manager)  📊 Registry                 │
└─────────────────────────────────────────────────────────┘
```

### 3.2 数据流向

```
┌─────────────┐
│   用户需求   │
└──────┬──────┘
       │
       ▼
┌─────────────┐       ┌─────────────┐
│ Lesson-     │       │   Schema    │
│ Weaver      │◄──────┤  Contract   │
│ Agent       │       └─────────────┘
└──────┬──────┘
       │ 生成
       ▼
┌─────────────┐       ┌─────────────┐
│ lesson.yml  │──────►│  Validator  │
│ (Data)      │       │   Engine    │
└──────┬──────┘       └─────────────┘
       │ 验证通过
       ▼
┌─────────────┐       ┌─────────────┐
│  Template   │◄──────┤  course.yml │
│  Engine     │       │   (Config)  │
└──────┬──────┘       └─────────────┘
       │ 合成
       ▼
┌─────────────┐
│ lesson.docx │
│ (Output)    │
└─────────────┘
```

---

## 4. 三层分离架构

### 4.1 Schema层（数据契约层）

**位置**: `schemas/`

**职责**:
- 定义数据结构和验证规则
- 作为AI、验证、生成的统一标准
- 版本化管理数据契约

**文件清单**:
```
schemas/
├── course_schema.yml     # Course级别配置 (v2.0新增)
├── lesson_schema.yml     # Lesson数据结构
├── outline_schema.yml    # Outline数据结构
├── cover_schema.yml      # Cover数据结构
└── README.md             # Schema文档
```

**示例**:
```yaml
# lesson_schema.yml
lesson:
  title:
    type: string
    description: "课程标题"
    required: true
  
  objectives:
    type: list
    description: "教学目标"
    items:
      type: string
    required: true
```

### 4.2 Template层（模板层）

**位置**: `templates/`

**职责**:
- 定义文档的呈现样式和排版
- 使用占位符关联Schema字段
- 与数据层解耦，独立演进

**文件清单**:
```
templates/
├── lesson/
│   └── lesson.docx       # Lesson模板
├── cover/
│   └── cover.docx        # 封面模板
└── outline/              # Outline模板（规划中）
```

**占位符规范**:
```
{{lesson.title}}          # 简单字段
{{lesson.objectives}}     # 列表循环
{{lesson.metadata.date}}  # 嵌套字段
```

### 4.3 Data层（数据层）

**位置**: `courses/`

**职责**:
- 存储具体的课程内容数据
- 遵循Schema定义的结构
- Course级别配置统一管理

**目录结构**:
```
courses/
└── course-XXX/
    ├── course.yml        # ⭐ v2.0: Course级别配置
    │                     #   - template_override
    │                     #   - schema_version
    │                     #   - metadata
    │
    ├── lessons/          # Lesson数据
    │   ├── lesson1.yml
    │   └── lesson2.yml
    │
    ├── outline/          # Outline数据
    │   └── outline.yml
    │
    ├── cover/            # Cover数据
    │   └── cover.yml
    │
    └── output/           # 生成的文档
```

**v2.0核心变化: course.yml**
```yaml
# course.yml - Course级别统一配置
course_id: "course-001"
title: "字体设计基础"
schema_version: "v2.0"

# 模板配置（可选，覆盖全局模板）
template_override:
  lesson: "custom/lesson-template.docx"
  cover: null  # 使用全局默认

# 元数据
metadata:
  instructor: "张老师"
  semester: "2024春季"
  credits: 3
```

---

## 5. 核心组件

### 5.1 Lesson-Weaver Agent (AI Agent)

**版本**: v2.0  
**文件**: `agents/lesson-weaver.md`

**核心升级**:
- ✅ 主动引导工作流（询问、建议、决策）
- ✅ 状态感知（读取course.yml，了解课程上下文）
- ✅ Schema驱动生成（严格遵循Schema契约）

**工作流状态机**:
```
START → 课程识别 → 需求收集 → 数据生成 → 验证 → 输出 → END
         ↓           ↓           ↓         ↓      ↓
      读course.yml  主动询问   遵循Schema  自动校验  docx
```

### 5.2 Schema Validator (验证引擎)

**职责**:
- 验证YAML数据是否符合Schema定义
- 自动化测试集成
- 错误定位和报告

**使用**:
```python
from tools.course_manager import CourseManager

manager = CourseManager("course-001")
is_valid = manager.validate_lesson("lesson1.yml")
```

### 5.3 Document Generator (文档生成器)

**职责**:
- 读取Data层YAML
- 应用Template层模板
- 生成最终docx文档

**调用**:
```python
manager.generate_lesson_doc("lesson1.yml")
```

### 5.4 Course Manager (课程管理工具)

**文件**: `tools/course_manager.py`

**功能**:
- Course级别配置读取（v2.0）
- 模板路径解析（支持template_override）
- 批量文档生成
- 数据验证集成

---

## 6. 技术栈

### 6.1 核心依赖

| 技术 | 版本 | 用途 |
|------|------|------|
| **Python** | 3.7+ | 主语言 |
| **PyYAML** | 6.0+ | YAML解析 |
| **python-docx** | 0.8.11+ | Word文档生成 |
| **pytest** | 7.0+ | 测试框架 |

### 6.2 开发工具

- **Git**: 版本控制
- **VS Code / Cursor**: 开发环境
- **Black**: 代码格式化
- **MyPy**: 类型检查（可选）

---

## 7. 工作流程

### 7.1 完整流程（使用Lesson-Weaver）

```
1. 用户: "我要创建一个新课程的Lesson"
   Agent: "好的，请问是为哪个课程？"（读取courses/目录）

2. 用户: "course-001"
   Agent: （读取course.yml）"这是'字体设计基础'课程，
          当前有2个lesson，是否继续创建lesson3？"

3. 用户: "是的"
   Agent: （遵循lesson_schema.yml）
          "请提供以下信息：
          - 课程标题
          - 教学目标（至少1个）
          - ..."

4. 用户: 提供信息
   Agent: （生成lesson3.yml，遵循Schema）
          "数据已生成，是否验证？"

5. 用户: "验证"
   Agent: （调用Validator）
          "✅ 验证通过！是否生成docx文档？"

6. 用户: "生成"
   Agent: （调用Generator，应用template_override）
          "✅ 已生成: output/lesson3.docx"
```

### 7.2 手动流程（直接使用工具）

```bash
# 1. 创建Course结构
python tools/course_manager.py create course-002 "平面设计"

# 2. 手动编辑 lesson.yml（遵循Schema）
vim courses/course-002/lessons/lesson1.yml

# 3. 验证数据
python tools/course_manager.py validate course-002/lessons/lesson1.yml

# 4. 生成文档
python tools/course_manager.py generate course-002/lessons/lesson1.yml

# 5. 批量生成
python tools/course_manager.py batch-generate course-002
```

---

## 8. 版本演进

### 8.1 版本对比

| 特性 | v1.0-v1.3 | v1.4 | v2.0 |
|------|-----------|------|------|
| **数据驱动** | 手动YAML | Schema驱动 | Schema驱动 |
| **配置管理** | 分散 | 分散 | Course级别统一 |
| **Agent角色** | 数据生成 | 数据生成 | 引导+生成 |
| **模板管理** | 全局唯一 | 全局唯一 | 支持Course级别覆盖 |
| **三层分离** | 部分分离 | 完全分离 | 完全分离 |

### 8.2 迁移路径

**v1.x → v2.0**:
1. ✅ 添加 `course.yml`（可选，兼容无此文件的情况）
2. ✅ 更新 Lesson-Weaver 到 v2.0
3. ✅ 无需修改现有 YAML 数据
4. ✅ 无需修改模板文件

**向后兼容承诺**:
- v2.0完全兼容v1.4数据格式
- course.yml为可选配置
- 默认行为与v1.4一致

---

## 9. 相关文档

### 9.1 架构文档
- [Schema-Driven 架构](6-schema-driven-architecture.md) - 深入理解Schema驱动
- [Agent 架构 v2.0](8-agent-driven-architecture-v2.md) - Agent设计详解
- [Lesson-Weaver 集成](7-lesson-weaver-integration.md) - Agent使用指南

### 9.2 设计决策
- [ADR-001: 清晰架构重构](ADR-001-clean-architecture-refactoring.md) - 架构重构决策记录

### 9.3 快速上手
- [快速上手指南](../../ARCHITECTURE_V2_QUICK_START.md) - 5分钟了解v2.0
- [架构重构总结](../../ARCHITECTURE_REFACTORING_SUMMARY.md) - 重构全景

### 9.4 开发文档
- [Schema 文档](../../schemas/README.md) - Schema详细说明
- [Course Manager 使用](../../tools/course_manager.py) - 工具使用说明
- [PRD](../prd.md) - 产品需求文档

---

## 📞 联系与支持

**架构负责人**: @architect.mdc  
**产品负责人**: @po.mdc  
**问题反馈**: 参见项目 [README](../../README.md)

---

**文档版本**: v2.0  
**最后更新**: 2025-10-05  
**下次审查**: 2025-11-05  
**维护者**: @architect.mdc

