# 6. Schema-Driven Architecture (æ¨¡å¼é©±åŠ¨æ¶æ„)

**ç‰ˆæœ¬**: v1.4.0+  
**æ›´æ–°æ—¥æœŸ**: 2025-10-04  
**çŠ¶æ€**: ğŸ”¥ Active Development

---

## 6.1 æ¦‚è¿° (Overview)

ä» v1.4.0 å¼€å§‹ï¼ŒDocu-Weaver å¼•å…¥äº† **Schema-Driven Architecture**ï¼ˆæ¨¡å¼é©±åŠ¨æ¶æ„ï¼‰ï¼Œå°†æ•°æ®å¥‘çº¦ï¼ˆData Contractï¼‰æå‡ä¸ºç³»ç»Ÿçš„ç¬¬ä¸€çº§æ¶æ„ç»„ä»¶ã€‚è¿™ä¸€è®¾è®¡ç†å¿µç¡®ä¿äº†ä» AI æ•°æ®ç”Ÿæˆã€æ•°æ®éªŒè¯åˆ°æ–‡æ¡£åˆæˆçš„å…¨æµç¨‹ä¸€è‡´æ€§å’Œå¯é æ€§ã€‚

---

## 6.2 æ¶æ„æ¼”è¿› (Architectural Evolution)

### v1.0-v1.3: å·¥å…·åŒ–é˜¶æ®µ (Tool-Centric)

```
[æ‰‹åŠ¨ç¼–å†™çš„ YAML] â†’ [æ¨¡æ¿] â†’ [ç”Ÿæˆè„šæœ¬] â†’ [è¾“å‡ºæ–‡æ¡£]
```

**ç‰¹ç‚¹**ï¼š
- âœ… åŠŸèƒ½å®Œæ•´ï¼Œæ»¡è¶³åŸºæœ¬éœ€æ±‚
- âš ï¸ æ•°æ®ç»“æ„éšå¼å®šä¹‰ï¼ˆä»…å­˜åœ¨äºæ¨¡æ¿å ä½ç¬¦ä¸­ï¼‰
- âš ï¸ ç¼ºå°‘æ•°æ®æ ‡å‡†ï¼Œæ˜“å‡ºé”™
- âš ï¸ AI é›†æˆå›°éš¾

---

### v1.4+: Schema é©±åŠ¨é˜¶æ®µ (Schema-Driven)

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Schema å¥‘çº¦    â”‚  â† æ¶æ„åŸºçŸ³
                    â”‚ (æ•°æ®è§„èŒƒå®šä¹‰)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                 â”‚                 â”‚
           â–¼                 â–¼                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ AI Agent â”‚      â”‚ æ•°æ®éªŒè¯  â”‚     â”‚ æ–‡æ¡£ç”Ÿæˆ  â”‚
    â”‚ æ•°æ®ç”Ÿæˆ  â”‚      â”‚  å¼•æ“    â”‚     â”‚  å¼•æ“    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹ç‚¹**ï¼š
- âœ… Schema ä½œä¸º"å•ä¸€äº‹å®æ¥æº" (Single Source of Truth)
- âœ… AI è¾“å‡ºç»“æ„åŒ–ã€è§„èŒƒåŒ–
- âœ… è‡ªåŠ¨åŒ–æ•°æ®éªŒè¯
- âœ… å®Œæ•´çš„æ¶æ„å¯è¿½æº¯æ€§

---

## 6.3 Schema åœ¨æ¶æ„ä¸­çš„ä½ç½® (Schema Placement)

### ç›®å½•ç»“æ„è®¾è®¡

```
nfu-docu-weaver/
â”‚
â”œâ”€â”€ ğŸ“‚ schemas/                    # ğŸ›ï¸ æ¶æ„å±‚ - æ•°æ®å¥‘çº¦
â”‚   â”œâ”€â”€ README.md                 # Schema ä½¿ç”¨æŒ‡å—
â”‚   â””â”€â”€ lesson_data_schema.yml    # è¯¾ç¨‹æ•™æ¡ˆ Schema (v2)
â”‚
â”œâ”€â”€ ğŸ“‚ templates/                  # ğŸ“„ è¡¨ç°å±‚ - æ–‡æ¡£æ¨¡æ¿
â”‚   â””â”€â”€ æ•™æ¡ˆå‚è€ƒæ¨¡æ¿.docx
â”‚
â”œâ”€â”€ ğŸ“‚ data_source/               # ğŸ“Š æ•°æ®å±‚ - ä¸šåŠ¡æ•°æ®
â”‚   â”œâ”€â”€ lesson_01.yml             # (ç”± AI æˆ–äººå·¥ç”Ÿæˆ)
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ ğŸ“‚ output/                    # ğŸ“ è¾“å‡ºå±‚ - æœ€ç»ˆæ–‡æ¡£
â”‚
â”œâ”€â”€ ğŸ“‚ prompts/                   # ğŸ¤– æŒ‡ä»¤å±‚ - AI æç¤ºè¯
â”‚   â””â”€â”€ lesson_generator.md      # (v2.0 å¼•å…¥)
â”‚
â””â”€â”€ ğŸ“œ generate_documents.py      # ğŸ”§ æ‰§è¡Œå±‚ - æ ¸å¿ƒå¼•æ“
```

**è®¾è®¡åŸåˆ™**ï¼š
1. **å…³æ³¨ç‚¹åˆ†ç¦»** (Separation of Concerns)ï¼šæ¯ä¸ªç›®å½•èŒè´£å•ä¸€ã€æ¸…æ™°
2. **ç¨³å®šæ€§åˆ†å±‚**ï¼šschemas å’Œ templates ç¨³å®šï¼Œdata_source åŠ¨æ€å˜åŒ–
3. **å¯æ‰©å±•æ€§**ï¼šä¾¿äºæ·»åŠ æ–°çš„ schema å’Œæ¨¡æ¿ç±»å‹

---

## 6.4 Schema çš„ä¸‰å¤§æ ¸å¿ƒä½œç”¨ (Three Core Roles)

### ä½œç”¨ 1: AI Agent æŒ‡ä»¤æ ¸å¿ƒ

**åœºæ™¯**: ä½¿ç”¨ AI (GPT-4/Claude) æ ¹æ®å¤§çº²ç”Ÿæˆæ•™æ¡ˆæ•°æ®

**å·¥ä½œæµç¨‹**:
```
[è¯¾ç¨‹å¤§çº²] 
    â†“
[Prompt æ¨¡æ¿ + Schema åµŒå…¥]
    â†“
[AI Agent å¤„ç†]
    â†“
[ç¬¦åˆ Schema çš„ YAML æ•°æ®]
```

**Prompt ç¤ºä¾‹**:
```markdown
ä½ æ˜¯è¯¾ç¨‹è®¾è®¡ä¸“å®¶ã€‚è¯·ä¸¥æ ¼éµå¾ªä»¥ä¸‹ YAML Schema ç”Ÿæˆæ•°æ®ï¼š

```yaml
# [åµŒå…¥å®Œæ•´çš„ lesson_data_schema.yml]
```

ç°åœ¨ï¼Œè¯·ä¸º"ç¬¬ä¸‰ç«  å­—ä½“è¯†åˆ«"ç”Ÿæˆå¯¹åº”çš„æ•™æ¡ˆæ•°æ®ã€‚
```

**æ•ˆæœ**:
- ğŸ¯ ç»“æ„åŒ–è¾“å‡ºï¼Œæ— éœ€äººå·¥æ•´ç†
- ğŸ¯ å­—æ®µå®Œæ•´æ€§è‡ªåŠ¨ä¿è¯
- ğŸ¯ å‡å°‘ 80%+ çš„äººå·¥æ ¡æ­£å·¥ä½œ

---

### ä½œç”¨ 2: æ•°æ®éªŒè¯æ ‡å‡†

**åœºæ™¯**: åœ¨æ–‡æ¡£ç”Ÿæˆå‰è‡ªåŠ¨éªŒè¯æ•°æ®å®Œæ•´æ€§

**éªŒè¯æ¶æ„**:
```python
class SchemaValidator:
    """åŸºäº Schema çš„éªŒè¯å™¨"""
    
    def load_schema(self, schema_path: Path) -> dict:
        """åŠ è½½ Schema å®šä¹‰"""
        
    def extract_rules(self, schema: dict) -> ValidationRules:
        """æå–éªŒè¯è§„åˆ™ï¼š
        - å¿…éœ€å­—æ®µåˆ—è¡¨
        - æ•°æ®ç±»å‹å®šä¹‰
        - åµŒå¥—ç»“æ„è§„åˆ™
        - æ ¼å¼çº¦æŸ
        """
        
    def validate(self, data_path: Path) -> ValidationResult:
        """æ‰§è¡ŒéªŒè¯ï¼Œè¿”å›è¯¦ç»†ç»“æœ"""
```

**éªŒè¯æµç¨‹**:
```
1. åŠ è½½ Schema â†’ æå–è§„åˆ™
2. è§£ææ•°æ®æ–‡ä»¶ â†’ æ£€æŸ¥è¯­æ³•
3. å¯¹æ¯” Schema â†’ éªŒè¯å®Œæ•´æ€§
4. ç”ŸæˆæŠ¥å‘Š â†’ é€šè¿‡/å¤±è´¥/è­¦å‘Š
```

**éªŒè¯é¡¹ç›®**:
- âœ… YAML è¯­æ³•æ­£ç¡®æ€§
- âœ… å¿…éœ€å­—æ®µå­˜åœ¨æ€§ï¼ˆåŸºäº Schemaï¼‰
- âœ… æ•°æ®ç±»å‹åŒ¹é…ï¼ˆstring/int/list/objectï¼‰
- âœ… åµŒå¥—ç»“æ„å®Œæ•´æ€§ï¼ˆå¦‚ `class_hours.total`ï¼‰
- âš ï¸ é¢å¤–å­—æ®µè­¦å‘Šï¼ˆå¯èƒ½çš„æ‹¼å†™é”™è¯¯ï¼‰

---

### ä½œç”¨ 3: æ–‡æ¡£ç”Ÿæˆå‚è€ƒ

**åœºæ™¯**: å¼€å‘å’Œç»´æŠ¤é˜¶æ®µçš„å‚è€ƒæ‰‹å†Œ

**ç”¨é€”**:
- ğŸ“– ç†è§£æ¨¡æ¿å ä½ç¬¦ `{{key}}` çš„å«ä¹‰
- ğŸ“– äº†è§£æ•°æ®çš„å®Œæ•´ç»“æ„å’Œå±‚çº§
- ğŸ“– ä½œä¸ºç”¨æˆ·çš„æ•°æ®å¡«å†™æŒ‡å—
- ğŸ“– ä½œä¸ºå¼€å‘è€…çš„ API æ–‡æ¡£

---

## 6.5 æ¶æ„æµç¨‹å›¾ (Architecture Flow)

### å®Œæ•´æ•°æ®æµ

```mermaid
graph TB
    A[è¯¾ç¨‹å¤§çº²] --> B{AI Agent}
    C[Schema å¥‘çº¦] -.æŒ‡ä»¤.-> B
    B --> D[ç”Ÿæˆ YAML æ•°æ®]
    
    D --> E{Schema éªŒè¯å™¨}
    C -.è§„åˆ™.-> E
    
    E -->|é€šè¿‡| F[æ–‡æ¡£ç”Ÿæˆå¼•æ“]
    E -->|å¤±è´¥| G[é”™è¯¯æŠ¥å‘Š]
    
    H[Word æ¨¡æ¿] --> F
    C -.å‚è€ƒ.-> F
    
    F --> I[æœ€ç»ˆæ–‡æ¡£]
    
    style C fill:#ffeb3b,stroke:#f57c00,stroke-width:3px
    style E fill:#4caf50,stroke:#2e7d32,stroke-width:2px
    style B fill:#2196f3,stroke:#1565c0,stroke-width:2px
    style F fill:#9c27b0,stroke:#6a1b9a,stroke-width:2px
```

**å…³é”®è§‚å¯Ÿ**:
- ğŸŸ¡ **Schema** æ˜¯è¿æ¥ä¸‰ä¸ªç¯èŠ‚çš„ä¸­å¿ƒèŠ‚ç‚¹
- ğŸŸ¢ **éªŒè¯å™¨** æ˜¯è´¨é‡ä¿éšœçš„å…³é”®é—¨æ§
- ğŸ”µ **AI Agent** å®ç°è‡ªåŠ¨åŒ–å†…å®¹ç”Ÿæˆ
- ğŸŸ£ **ç”Ÿæˆå¼•æ“** å®Œæˆæœ€ç»ˆæ–‡æ¡£åˆæˆ

---

## 6.6 Schema ç‰ˆæœ¬ç®¡ç† (Schema Versioning)

### ç‰ˆæœ¬ç­–ç•¥

**å‘½åè§„èŒƒ**:
```
schemas/
â”œâ”€â”€ lesson_data_schema.yml        # æŒ‡å‘å½“å‰ç‰ˆæœ¬ï¼ˆç¬¦å·é“¾æ¥æˆ–å‰¯æœ¬ï¼‰
â”œâ”€â”€ lesson_data_schema_v1.yml     # å†å²ç‰ˆæœ¬
â”œâ”€â”€ lesson_data_schema_v2.yml     # å½“å‰ç‰ˆæœ¬
â””â”€â”€ lesson_data_schema_v3.yml     # æœªæ¥ç‰ˆæœ¬ï¼ˆå¼€å‘ä¸­ï¼‰
```

**å…¼å®¹æ€§åŸåˆ™**:
1. **å‘åå…¼å®¹å˜æ›´** (Minor Version)
   - æ–°å¢å¯é€‰å­—æ®µ âœ…
   - æ–°å¢æ³¨é‡Šè¯´æ˜ âœ…
   - ç¤ºä¾‹æ•°æ®æ›´æ–° âœ…

2. **ç ´åæ€§å˜æ›´** (Major Version)
   - å¿…éœ€å­—æ®µåˆ é™¤ âš ï¸
   - å­—æ®µé‡å‘½å âš ï¸
   - ç»“æ„å±‚çº§å˜æ›´ âš ï¸
   - éœ€åˆ›å»ºæ–°ç‰ˆæœ¬æ–‡ä»¶å¹¶æ›´æ–°éªŒè¯å™¨

**ç‰ˆæœ¬å‡çº§æµç¨‹**:
```
1. è¯„ä¼°å˜æ›´å½±å“
2. åˆ›å»ºæ–°ç‰ˆæœ¬ Schema
3. æ›´æ–°éªŒè¯å™¨æ”¯æŒå¤šç‰ˆæœ¬
4. æä¾›è¿ç§»è„šæœ¬ï¼ˆå¦‚éœ€è¦ï¼‰
5. æ›´æ–°æ–‡æ¡£å’Œç¤ºä¾‹
6. æ¸è¿›å¼åºŸå¼ƒæ—§ç‰ˆæœ¬
```

---

## 6.7 è®¾è®¡æ¨¡å¼ (Design Patterns)

### 1. Contract-First Design (å¥‘çº¦ä¼˜å…ˆè®¾è®¡)

**åŸåˆ™**: Schema å…ˆäºå®ç°å®šä¹‰

**æµç¨‹**:
```
1. å®šä¹‰ Schema (æ•°æ®å¥‘çº¦)
2. è¯„å®¡å’Œæ‰¹å‡† Schema
3. åŸºäº Schema å¼€å‘éªŒè¯å™¨
4. åŸºäº Schema å¼€å‘ç”Ÿæˆå™¨
5. åŸºäº Schema ç”Ÿæˆæ•°æ®
```

---

### 2. Single Source of Truth (SSOT)

**åŸåˆ™**: Schema æ˜¯æ•°æ®ç»“æ„çš„å”¯ä¸€æƒå¨æ¥æº

**å®è·µ**:
- âŒ ä¸åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å­—æ®µåˆ—è¡¨
- âŒ ä¸ä¾èµ–æ¨¡æ¿æ¨æ–­ç»“æ„
- âœ… æ‰€æœ‰ç»„ä»¶ä» Schema è¯»å–è§„åˆ™
- âœ… Schema å˜æ›´è‡ªåŠ¨ä¼ æ’­åˆ°æ‰€æœ‰ç»„ä»¶

---

### 3. Fail-Fast Validation (å¿«é€Ÿå¤±è´¥éªŒè¯)

**åŸåˆ™**: åœ¨æµç¨‹æ—©æœŸå‘ç°å¹¶é˜»æ­¢é”™è¯¯æ•°æ®

**å®è·µ**:
```python
def generate_document_pipeline(data_path, template_path):
    # 1. é¦–å…ˆéªŒè¯ (Fail Fast)
    validation_result = schema_validator.validate(data_path)
    if not validation_result.is_valid:
        raise ValidationError(validation_result.errors)
    
    # 2. éªŒè¯é€šè¿‡åå†ç”Ÿæˆ
    return document_generator.generate(data_path, template_path)
```

---

## 6.8 æŠ€æœ¯å®ç°è·¯çº¿å›¾ (Technical Roadmap)

### Phase 1: Schema åŸºç¡€è®¾æ–½ (v1.4.0) ğŸ”¥
- [x] åˆ›å»º schemas/ ç›®å½•
- [x] å®šä¹‰ lesson_data_schema.yml v2
- [ ] å®ç° SchemaValidator ç±»
- [ ] é›†æˆåˆ° validate å‘½ä»¤
- [ ] å®Œæ•´çš„å•å…ƒæµ‹è¯•

### Phase 2: AI å·¥ä½œæµé›†æˆ (v2.0.0)
- [ ] åˆ›å»º prompts/ ç›®å½•
- [ ] å¼€å‘ AI Prompt æ¨¡æ¿
- [ ] Schema è‡ªåŠ¨åµŒå…¥æœºåˆ¶
- [ ] AI è¾“å‡ºè‡ªåŠ¨éªŒè¯
- [ ] äº¤äº’å¼å·¥ä½œæµ

### Phase 3: é«˜çº§ç‰¹æ€§ (v2.x)
- [ ] å¤š Schema æ”¯æŒ
- [ ] Schema ç»§æ‰¿å’Œç»„åˆ
- [ ] JSON Schema æ ‡å‡†å…¼å®¹
- [ ] Schema å¯è§†åŒ–ç¼–è¾‘å™¨
- [ ] Schema è‡ªåŠ¨ç”Ÿæˆå·¥å…·

---

## 6.9 æœ€ä½³å®è·µ (Best Practices)

### âœ… DO (æ¨èåšæ³•)

1. **Schema ä¼˜å…ˆå¼€å‘**
   - æ–°åŠŸèƒ½å…ˆå®šä¹‰ Schema
   - Schema å˜æ›´éœ€è¯„å®¡æ‰¹å‡†

2. **Schema å³æ–‡æ¡£**
   - æ·»åŠ è¯¦ç»†çš„æ³¨é‡Šè¯´æ˜
   - æä¾›ç¤ºä¾‹æ•°æ®
   - è¯´æ˜å­—æ®µç”¨é€”å’Œæ ¼å¼

3. **Schema ç‰ˆæœ¬æ§åˆ¶**
   - é‡å¤§å˜æ›´åˆ›å»ºæ–°ç‰ˆæœ¬
   - ä¿æŒå‘åå…¼å®¹æ€§
   - æä¾›å‡çº§è·¯å¾„

4. **è‡ªåŠ¨åŒ–éªŒè¯**
   - ç”Ÿæˆå‰å¿…é¡»éªŒè¯
   - CI/CD é›†æˆéªŒè¯æ£€æŸ¥
   - éªŒè¯å¤±è´¥å¿«é€Ÿåé¦ˆ

---

### âŒ DON'T (é¿å…åšæ³•)

1. **ç»•è¿‡ Schema**
   - ä¸è¦ç›´æ¥ä¿®æ”¹æ•°æ®ç»•è¿‡éªŒè¯
   - ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç ç»“æ„

2. **Schema ä¸å®ç°ä¸åŒæ­¥**
   - ä¿®æ”¹ä»£ç åå¿…é¡»æ›´æ–° Schema
   - Schema æ˜¯æƒå¨å®šä¹‰

3. **è¿‡åº¦å¤æ‚çš„ Schema**
   - é¿å…è¿‡æ·±çš„åµŒå¥—ï¼ˆ>4 å±‚ï¼‰
   - ä¿æŒç»“æ„æ¸…æ™°æ˜“æ‡‚

---

## 6.10 ç›¸å…³æ–‡æ¡£ (Related Documents)

- [Schema ä½¿ç”¨æŒ‡å—](../../schemas/README.md)
- [æ•°æ®éªŒè¯åŠŸèƒ½](../prd.md#story-24-æ•°æ®éªŒè¯)
- [Sprint 4 è®¡åˆ’](../SPRINT_PROGRESS.md#sprint-4)
- [CHANGELOG - Schema é›†æˆ](../../CHANGELOG.md)

---

**æœ€åæ›´æ–°**: 2025-10-04  
**ä½œè€…**: Architect + Product Owner  
**çŠ¶æ€**: ğŸ”¥ Active Development

