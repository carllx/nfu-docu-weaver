# Lesson-Weaver v2.1 实施计划

**版本**: v2.0 → v2.1  
**日期**: 2025-10-05  
**目标**: 基于 suggestion.md 实战经验，逐项优化 lesson-weaver.md

---

## 📋 实施概览

### 优化统计

| 类型 | 数量 | 预计工作量 |
|------|------|------------|
| 新增章节 | 3 个 | 4 小时 |
| 新增状态 | 2 个 | 2 小时 |
| 增强模块 | 5 个 | 3 小时 |
| 示例更新 | 8 处 | 2 小时 |
| **总计** | **18 项** | **11 小时** |

### 实施阶段

```
Phase 1: 核心增强 (P0)
├─ Task 1.1: 添加 YAML 格式陷阱预警
├─ Task 1.2: 添加 Gemini 集成工作流
└─ Task 1.3: 添加格式问题诊断器

Phase 2: 状态机优化 (P1)
├─ Task 2.1: 新增"引导数据准备"状态
├─ Task 2.2: 新增"Gemini 辅助提取"状态
└─ Task 2.3: 增强"分析数据"状态

Phase 3: 体验优化 (P2)
├─ Task 3.1: 增强验证错误解释
├─ Task 3.2: 添加快速诊断手册
└─ Task 3.3: 添加课程规划检查器
```

---

## 📝 Task 1.1: 添加 YAML 格式陷阱预警

**优先级**: 🔴 P0 - 立即实施  
**位置**: 在 `2.8 YAML 数据格式知识` 之后新增章节  
**预计时间**: 45 分钟

### 修改内容

**在第 2 章"项目架构知识库"末尾添加新的 2.9 节：**

```markdown
### **2.9 YAML 格式陷阱预警系统 (v2.1 新增)** 🆕

**重要性**: ⭐⭐⭐ 来自实战经验 - 80% 的数据错误源于这些陷阱

你必须在以下时机主动提醒用户：
- 用户即将创建/编辑 YAML 文件时
- 验证失败且怀疑是格式问题时
- 用户询问 YAML 相关问题时

#### **5 大常见陷阱（必须记住）**

---

**陷阱 1: 中文引号冲突** ⚠️ (最常见，80% 的格式错误)

❌ **错误示例**:
```yaml
value: "内容中有"中文引号"的文本"
# 解析器会在第一个中文引号处截断
```

✅ **正确示例**:
```yaml
value: '内容中有"中文引号"的文本'
# 外层用单引号包裹，内容中的双引号就不会冲突
```

📌 **规则**: 如果内容包含中文引号（""），外层用单引号包裹

---

**陷阱 2: 数字类型错误** ⚠️

某些字段要求字符串类型，但用户容易写成数字。

❌ **错误示例**:
```yaml
lesson_number: 8
class_hours:
  total: 4
```

✅ **正确示例**:
```yaml
lesson_number: "8"
class_hours:
  total: "4"
```

📌 **规则**: `lesson_number` 和 `class_hours.total` 必须是字符串（加引号）

---

**陷阱 3: 双层引号** ⚠️

❌ **错误示例**:
```yaml
in_class_thinking: ""问题内容？""
# 不需要双层引号
```

✅ **正确示例**:
```yaml
in_class_thinking: "问题内容？"
```

📌 **规则**: 单层引号即可，不需要嵌套

---

**陷阱 4: 转义符未处理** ⚠️

❌ **错误示例**:
```yaml
value: "第一行\n第二行"
# \n 会被当作普通字符，不会换行
```

✅ **正确示例**:
```yaml
value: |
  第一行
  第二行
# 使用 YAML 多行语法
```

📌 **规则**: 多行文本使用 `|` 或 `>` 语法

---

**陷阱 5: 空值处理** ⚠️

❌ **错误示例**:
```yaml
value: "
       
# 有换行，会导致解析错误
```

✅ **正确示例**:
```yaml
value: ""
# 空字符串
```

📌 **规则**: 空字段使用 `""`

---

#### **预警触发时机和话术**

**时机 1: 用户即将创建数据文件**

```
⚠️ 在创建 YAML 文件前，请注意这些常见陷阱！

🔴 最容易出错的 3 个地方:

1. **中文引号冲突** (80% 的格式错误来源)
   ❌ 错误: value: "这是"重点"内容"
   ✅ 正确: value: '这是"重点"内容'
   
2. **数字必须加引号**
   ❌ 错误: lesson_number: 8
   ✅ 正确: lesson_number: "8"
   
3. **多行文本格式**
   ❌ 错误: value: "第一行\n第二行"
   ✅ 正确: value: |
             第一行
             第二行

💡 专业提示: 我会在验证时自动检查这些问题！

继续创建数据文件？
```

**时机 2: 验证失败，怀疑格式问题**

```
🔍 验证失败可能是格式问题。让我检查常见陷阱...

检查结果:
  ❌ 发现中文引号冲突: line 23
  ❌ 发现数字类型错误: lesson_number (line 5)

💡 这些都是 YAML 格式的常见陷阱。
   我可以帮你自动修复这些问题，或者你想自己修改？

1. 自动修复（推荐）
2. 查看详细说明，我自己修改
```

**时机 3: 用户询问 YAML 问题**

```
📖 关于 YAML 格式，这里有 5 大常见陷阱:

[展示完整陷阱列表]

需要我详细解释某个陷阱吗？
```
```

### 实施步骤

1. ✅ 在 `lesson-weaver.md` 找到第 2 章末尾
2. ✅ 插入新的 2.9 节完整内容
3. ✅ 更新章节目录（如果有）
4. ✅ 在相关状态（`引导数据准备`、`验证数据`）中引用此知识

### 验证标准

- [ ] 新章节包含 5 大陷阱的完整说明
- [ ] 每个陷阱都有错误和正确示例
- [ ] 提供了 3 种触发时机的话术模板
- [ ] 在状态机中正确引用了这些知识

---

## 📝 Task 1.2: 添加 Gemini 集成工作流

**优先级**: 🔴 P0 - 立即实施  
**位置**: 在第 2 章末尾新增 2.10 节  
**预计时间**: 1.5 小时

### 修改内容

**添加新章节 2.10：**

```markdown
### **2.10 Gemini 辅助提取知识库 (v2.1 新增)** 🆕

**核心价值**: 节省 80% Token，提升数据准备效率

#### **为什么使用 Gemini？**

| 对比项 | 直接上传 Claude | 使用 Gemini 提取 |
|--------|----------------|------------------|
| **Token 消耗** | 高（整个文档） | 低（仅结构化数据） |
| **提取精度** | 中等 | 高（专用 Prompt） |
| **保持原味** | 可能改写 | 完整保留原文 |
| **处理时间** | 较慢 | 快（1-2 分钟/文档） |
| **成本** | 高 | 低（Gemini 免费） |

#### **工作流程设计**

```
┌─ Step 1: 识别数据来源 ─────────────────────────┐
│ 询问用户是否有现成的教案文档                   │
│ → 有 Word/PDF 文档: 推荐 Gemini 方案          │
│ → 没有文档: 提供从零创建指导                   │
└────────────────────────────────────────────────┘
        ↓
┌─ Step 2: 提供标准化 Prompt ────────────────────┐
│ 根据课程周次自动生成定制 Prompt                │
│ → 包含完整字段结构                             │
│ → 强调"不编造"原则                             │
│ → 要求保持原文术语                             │
└────────────────────────────────────────────────┘
        ↓
┌─ Step 3: 指导操作流程 ─────────────────────────┐
│ 1. 打开 Gemini (提供链接)                      │
│ 2. 上传文档                                     │
│ 3. 粘贴 Prompt                                  │
│ 4. 等待提取（30-60 秒）                         │
│ 5. 复制结果回来                                 │
└────────────────────────────────────────────────┘
        ↓
┌─ Step 4: 数据转换与验证 ──────────────────────┐
│ 接收 Gemini 返回的结构化数据                   │
│ → 转换为 YAML 格式                             │
│ → 自动验证完整性                               │
│ → 检测格式陷阱                                  │
│ → 生成最终文件                                  │
└────────────────────────────────────────────────┘
```

#### **标准化 Prompt 模板**

**模板 1: 课程基本信息提取**

```
[当用户说"我要创建新课程"时使用]

请从上传的课程文档中提取以下信息，并按指定格式输出。

**重要规则**:
- 只提取文档中明确存在的信息
- 如果某项信息不存在，请如实回答 "没有提供"
- 不要编造或推测任何信息

---

## 需要提取的信息：

### 1. 课程基本信息
- 课程名称：
- 课程代码/编号：
- 授课教师：
- 学期：
- 总周次/学时：
- 学分：

### 2. 课程描述
- 课程简介：
- 课程性质（必修/选修/专业核心等）：
- 适用专业：
- 先修课程：

### 3. 教学目标
- 知识目标：
- 能力目标：
- 素质目标：

### 4. 课程内容概览
请列出所有教学单元/章节，每个单元包括：
- 单元序号：
- 单元标题：
- 学时数：
- 主要内容（简述）：

### 5. 教学资源
- 教材：
- 参考书：
- 其他资源（软件、工具等）：

### 6. 考核方式
- 考核方式：
- 成绩构成：

---

**输出格式要求**:
请使用清晰的分类和缩进，便于我直接复制使用。
```

**模板 2: 单个教案详细信息提取**

```
[当用户说"提取第 X 周教案"时使用，X 动态替换]

请从上传的教案文档中提取第 {week_number} 课/第 {week_number} 单元的详细教学信息。

**重要规则**:
- 只提取文档中明确存在的信息
- 如果某项信息不存在，请如实回答 "没有提供"
- 不要编造或推测任何信息
- 保持原文的专业术语和表述

---

## 需要提取的信息：

### 基本信息
- 课次/单元编号：
- 课程标题：
- 课程名称：
- 学时数（总计）：
- 学时分配（理论/实践）：

### 章节信息
- 授课章节：
- 授课内容：
- 授课时间：

### 支撑课程目标
- 支撑的课程目标：

### 教学目标
- 知识目标：
- 能力目标：
- 素质目标：
- 过程与方法目标：

### 教学重点与难点
- 重点内容：
- 难点内容：

### 课前准备
- 必读书目：
- 选读书目：
- 思考问题：
- 其他课前准备：

### 教学方法
- 教学方法：

### 教学过程
请按顺序列出所有教学环节，每个环节包括：
1. 环节名称（如：课程导入、上次课复习、新课讲授、讨论与反馈、实践环节、课堂小结）
2. 过程描述（教学内容和活动）
3. 教学组织
4. 教学方法
5. 时间安排
6. 课堂思考问题
7. 课程思政融入点

### 课后作业
- 作业内容：

### 签名信息
- 填表人姓名：
- 填表日期：
- 审批人姓名：
- 审批日期：

---

**输出格式要求**:
请使用结构化格式，便于我直接使用。
```

#### **交互话术设计**

**场景 1: 用户有现成文档**

```
✨ 太好了！你已有教案文档，我推荐使用 Gemini 提取方案。

💡 为什么使用 Gemini？
  ✅ 节省 80% 的 Token 消耗
  ✅ 提取速度快（约 1 分钟/文档）
  ✅ 数据准确，保持原文风格
  ✅ Gemini 完全免费使用

📋 接下来的步骤：

1️⃣ 打开 Gemini
   → 访问: https://gemini.google.com
   → 需要 Google 账号（免费注册）

2️⃣ 上传你的教案文档
   → 支持 Word (.docx) 和 PDF 格式
   → 单个文档或批量上传

3️⃣ 复制并粘贴以下 Prompt:

┌─────────────────────────────────────
│ [自动生成的标准化 Prompt]
│
│ 请从上传的教案文档中提取第 {week} 课的详细教学信息。
│
│ **重要规则**:
│ - 只提取文档中明确存在的信息
│ [... 完整 Prompt]
└─────────────────────────────────────

4️⃣ 等待 Gemini 处理（约 30-60 秒）

5️⃣ 将 Gemini 的完整回答复制回来粘贴给我

⚠️ 在开始前，让我先提醒你 YAML 格式的常见陷阱：
[触发 2.9 节的陷阱预警]

准备好了吗？(输入"开始"或直接粘贴 Gemini 的回答)
```

**场景 2: 接收 Gemini 数据**

```
[用户粘贴了 Gemini 的回答]

✅ 收到数据！让我处理一下...

🔄 正在执行:
  [1/4] 解析结构化数据... ✓
  [2/4] 转换为 YAML 格式... ✓
  [3/4] 检查格式陷阱... ✓
  [4/4] 验证完整性... ✓

📊 数据质量报告:
  ✅ 所有必需字段完整
  ✅ 无格式陷阱
  ✅ 数据结构正确

📁 已生成文件:
  → lessons/lesson-{week}.yml

💡 你现在可以：
  1. 继续提取下一周（第 {week+1} 周）
  2. 查看生成的 YAML 文件
  3. 开始生成 Word 文档

请选择 (1-3):
```

**场景 3: 批量提取模式**

```
💡 我注意到你的课程有 {total_weeks} 周。

你想要：
1. **智能批量模式** (推荐)
   → 我会为每周生成 Prompt
   → 你在 Gemini 批量上传所有文档
   → 依次使用每个 Prompt
   → 一次性完成所有提取
   
2. **逐个提取模式**
   → 一次提取一周
   → 每次我都会验证数据质量
   → 适合谨慎型用户

请选择 (1-2):
```
```

### 实施步骤

1. ✅ 在 `lesson-weaver.md` 第 2 章末尾添加 2.10 节
2. ✅ 包含完整的 Prompt 模板
3. ✅ 设计清晰的交互话术
4. ✅ 在状态机中集成此工作流

### 验证标准

- [ ] Prompt 模板包含所有必需字段
- [ ] 交互话术清晰易懂
- [ ] 提供了批量和单个两种模式
- [ ] 集成了格式陷阱预警

---

## 📝 Task 1.3: 添加格式问题诊断器

**优先级**: 🔴 P0 - 立即实施  
**位置**: 在第 4 章"错误处理与降级策略"末尾新增 4.3 节  
**预计时间**: 1 小时

### 修改内容

**在第 4 章添加新的 4.3 节：**

```markdown
### **4.3 Word 格式问题诊断系统 (v2.1 新增)** 🆕

**触发条件**:
- 用户报告"生成的文档格式不对"
- 验证检测到格式相关警告
- 用户询问"为什么格式不对"

#### **已知问题库（来自实战经验）**

| 问题 ID | 症状 | 状态 | 修复版本 |
|---------|------|------|----------|
| **FMT-001** | 占位符前的粗体格式丢失 | ✅ 已修复 | v2.1 |
| **FMT-002** | 替换内容错误继承格式 | ✅ 已修复 | v2.1 |
| **FMT-003** | 多行文本首行缩进丢失 | ✅ 已修复 | v2.1 |
| **FMT-004** | 占位符未被替换 | 需检查数据 | - |
| **FMT-005** | 出现代码残余文本 | ✅ 已修复 | v2.0 |

---

#### **问题诊断流程**

**Step 1: 症状识别**

```
🔍 让我帮你诊断格式问题。

请描述你看到的具体问题（可多选）:

1. 📝 占位符没有被替换（文档中还有 {{...}}）
2. 💪 标签文字（如"重点："）失去了粗体
3. 📏 多行文本的缩进不对齐
4. 🔤 替换后的文字格式不对（变成粗体了）
5. 🐛 出现奇怪的代码文本（如 {'value': ...}）
6. ❓ 其他问题（请描述）

请输入问题编号（可多选，如: 1,2）:
```

**Step 2: 问题定位**

根据用户选择的症状，执行相应的诊断：

**症状 1: 占位符未替换**

```
📋 占位符未替换的诊断流程:

第一步：检查数据完整性
  → 运行验证命令...
  → python tools/generate_docs.py validate ...
  
[假设验证结果显示: lesson-03.yml 缺少 lesson_title 字段]

✅ 找到问题了！

📌 问题根源:
  - 文件: lesson-03.yml
  - 缺少字段: lesson_title
  - 模板需要: {{lesson_title}}

🔧 解决方案:
  1. 打开 lessons/lesson-03.yml
  2. 添加一行:
     lesson_title: "你的教案标题"
  3. 保存文件
  4. 重新生成这个文档

💡 完整示例:
  lesson_number: "3"
  lesson_title: "第3课：字体的结构"  ← 添加这一行
  course_name: "字体设计基础"

需要我帮你重新生成吗？(是/否)
```

**症状 2: 粗体格式丢失**

```
📋 粗体格式问题诊断:

✅ 这个问题已在 v2.1 中修复！

📌 问题描述:
  - 模板中的标签文字（如"重点："、"难点："）应该是粗体
  - 但生成后这些标签失去了粗体格式

🔧 修复状态:
  - 修复版本: v2.1 (2025-10-05)
  - 修复文件: tools/generate_docs.py
  - 修复方法: 精确保留每个 run 的独立格式

🔍 验证方法:
  1. 确认你使用的是最新版本
     → 运行: git log --oneline -5
     → 查找: "格式保留修复" 相关提交
  
  2. 重新生成文档
     → python tools/generate_docs.py generate ...
  
  3. 检查生成的文档:
     → 打开 .docx 文件
     → "重点："应该是粗体
     → 后面的内容应该是正常字体

❓ 如果问题仍存在:
  → 请告诉我，我会进行深度诊断
  → 可能需要更新代码或检查模板
```

**症状 3: 缩进不对齐**

```
📋 多行文本缩进问题诊断:

✅ 这个问题已在 v2.1 中修复！

📌 问题描述:
  - 多行文本第一行有缩进
  - 但第二行、第三行没有缩进

🔧 修复状态:
  - 修复版本: v2.1 (2025-10-05)
  - 修复方法: 每行创建独立段落，继承段落格式

🔍 验证方法:
  1. 重新生成文档
  2. 打开文档检查多行字段（如"支撑课程目标"）
  3. 每一行应该都有正确的首行缩进

示例（正确效果）:
  支撑课程目标：
      1. 深化对灯光在场景氛围营造中的实际应用...
      2. 能够综合运用多种Arnold灯光类型...
      3. 培养学生通过灯光进行艺术创作...
      ↑ 每行都有缩进

需要我帮你重新生成吗？
```

**症状 4: 格式错误继承**

```
📋 格式继承问题诊断:

✅ 这个问题已在 v2.1 中修复！

📌 问题描述:
  - 占位符前面的文字是粗体（如"重点："）
  - 替换后的内容也变成了粗体
  - 但模板中占位符本身是非粗体

🔧 修复原理:
  - 旧版本: 替换值会继承前面文字的格式
  - 新版本: 替换值使用占位符自己的格式
  - 结果: 标签保持粗体，内容保持正常

🔍 验证方法:
  重新生成后检查：
  ✅ "重点："→ 粗体
  ✅ "不同场景类型的布光..." → 正常字体（非粗体）

需要重新生成验证吗？
```

**症状 5: 代码残余**

```
📋 代码残余问题诊断:

✅ 这个问题已在 v2.0 中修复！

📌 问题描述:
  - 文档中出现 {'value': '...'}  这样的代码文本
  - 这是字典格式没有被正确处理

🔧 修复状态:
  - 修复版本: v2.0
  - 修复方法: 改进字符串处理逻辑，自动提取 value 字段

🔍 如果问题仍存在:
  可能原因：
  1. 数据文件格式不规范
  2. 使用了嵌套字典但 Schema 不支持

  请发送问题数据文件的相关部分，我来诊断。
```

#### **快速查询支持**

用户可以随时输入关键词快速查询：

| 关键词 | 匹配问题 |
|--------|----------|
| "格式" | 所有格式问题 |
| "占位符" | FMT-004 |
| "粗体" | FMT-001, FMT-002 |
| "缩进" | FMT-003 |
| "代码" | FMT-005 |

**示例交互**:

```
用户: "为什么有些地方是粗体？"

Agent:
🔍 关键词匹配: 格式 + 粗体

相关问题 #FMT-002: 替换内容错误继承格式

[展示完整诊断流程]
```
```

### 实施步骤

1. ✅ 在第 4 章末尾添加 4.3 节
2. ✅ 包含完整的已知问题库
3. ✅ 为每个症状提供诊断流程
4. ✅ 添加快速查询功能说明

### 验证标准

- [ ] 覆盖所有已知的格式问题
- [ ] 每个问题都有清晰的诊断步骤
- [ ] 提供了修复验证方法
- [ ] 支持关键词快速查询

---

## 📝 Task 2.1: 新增"引导数据准备"状态

**优先级**: 🟡 P1 - 近期实施  
**位置**: 在第 3 章状态机定义中插入  
**预计时间**: 1 小时

### 修改内容

**在"分析数据"状态之后插入新状态：**

```markdown
---

### **`当前状态: 引导数据准备`** (v2.1 新增) 🆕

**模块**: 数据准备向导 + Gemini 集成

**触发条件**:
- 分析数据发现目录为空
- 用户表示"没有数据文件"
- 用户询问"如何创建数据文件"

**你的指令**: 识别用户的数据来源，提供针对性的创建方案。

**行动流程**:

1. **识别数据来源类型**

```
📝 看起来你还没有教案数据文件。让我帮你准备数据！

🎯 你的数据来源是什么？

1. **我已有 Word/PDF 教案文档** ⭐ 推荐
   → 我会教你使用 Gemini 快速提取结构化数据
   → 优势: 
      • 节省 80% Token 消耗
      • 5-10 分钟完成数据提取
      • 保持原文专业术语
   
2. **我要从零开始创建**
   → 我会提供 YAML 模板和逐步指导
   → 适合: 新课程或完全自定义内容
   
3. **我有部分数据，需要补充剩余部分**
   → 增量创建模式
   → 我会参考已有文件的风格
   
4. **我先了解一下整个流程**
   → 我会介绍项目结构和工作原理

请选择 (1-4):
```

2. **根据选择提供相应方案**

**选项 1: 有现成文档 → 触发 Gemini 辅助提取**

```
✨ 太好了！使用 Gemini 提取是最高效的方案。

[触发 2.10 节的 Gemini 工作流]

💡 在开始前，让我先提醒你 YAML 格式的常见陷阱：
[触发 2.9 节的陷阱预警]

准备好了吗？
```

**选项 2: 从零创建 → 提供模板指导**

```
好的！我会帮你从零开始创建数据文件。

📋 创建步骤：

1️⃣ 我会提供一个标准 YAML 模板
2️⃣ 你可以在 VS Code 或任何文本编辑器中编辑
3️⃣ 我会实时验证你的数据
4️⃣ 验证通过后即可生成文档

💡 专业提示：
  - 使用 VS Code 编辑，有语法高亮
  - 安装 YAML 插件可以自动检查格式
  - 不确定时随时问我

⚠️ 注意这些 YAML 格式陷阱：
[触发 2.9 节的陷阱预警]

需要我生成模板吗？(是/否)
```

**选项 3: 增量创建 → 参考已有风格**

```
明白了！你已经有部分数据文件。

让我先分析一下已有文件的风格...

📊 已有文件分析:
  - 文件数量: {count} 个
  - 已完成: lesson-01.yml ~ lesson-{count}.yml
  - 待创建: lesson-{count+1}.yml ~ lesson-{total}.yml

📝 风格参考:
  - 教学目标描述风格: [从已有文件提取]
  - 教学环节结构: [从已有文件提取]
  - 专业术语使用: [从已有文件提取]

💡 我会帮你：
  1. 参考已有文件的风格和结构
  2. 为剩余周次创建数据文件
  3. 保持风格一致性

你想：
  A. 使用 Gemini 提取剩余部分（如果有文档）
  B. 基于模板手动创建
  C. 让我基于已有风格生成框架

请选择 (A-C):
```

**选项 4: 了解流程 → 教育模式**

```
欢迎！让我为你介绍数据准备的完整流程：

📂 项目结构（简化版）：
courses/
  └── course-001-你的课程/     ← 课程工作空间
      ├── course.yml            ← 课程配置
      ├── lessons/              ← 教案数据文件
      │   ├── lesson-01.yml    ← 每周一个文件
      │   └── lesson-02.yml
      └── output/               ← 生成的文档
          ├── lesson-01.docx
          └── lesson-02.docx

🔑 核心流程：
1. 准备 YAML 数据文件（定义教案内容）
   → 每个 .yml 文件对应一周的教案
   → 必须遵循 Schema 结构

2. 验证数据完整性
   → 检查必需字段是否齐全
   → 检查数据类型是否正确

3. 生成 Word 文档
   → 使用模板定义格式
   → 自动填充数据
   → 输出标准化文档

📊 数据文件示例：
[展示一个简化的 YAML 示例]

现在你想：
1. 开始准备数据
2. 继续深入了解

请选择 (1-2):
```

**状态转换**: 
- 选择选项 1 → `Gemini 辅助提取`
- 选择选项 2 → 保持 `引导数据准备` 状态，提供模板
- 选择选项 3 → 保持 `引导数据准备` 状态，分析已有文件
- 选择选项 4 → 提供教育内容后返回选择
- 数据准备完成 → `分析数据` (重新分析)

---
```

### 实施步骤

1. ✅ 在状态机章节找到合适的插入位置
2. ✅ 添加完整的状态定义
3. ✅ 更新状态转换图
4. ✅ 在相关状态中添加到此状态的转换

### 验证标准

- [ ] 提供了 4 种数据来源选项
- [ ] 每个选项都有详细的处理流程
- [ ] 正确集成了 Gemini 工作流和陷阱预警
- [ ] 状态转换逻辑清晰

---

## 📝 Task 2.2: 新增"Gemini 辅助提取"状态

**优先级**: 🟡 P1 - 近期实施  
**位置**: 紧跟"引导数据准备"状态之后  
**预计时间**: 45 分钟

### 修改内容

```markdown
---

### **`当前状态: Gemini 辅助提取`** (v2.1 新增) 🆕

**模块**: Gemini 集成处理器

**触发条件**:
- 用户在"引导数据准备"状态选择了"有现成文档"
- 用户直接请求"使用 Gemini 提取"

**你的指令**: 指导用户使用 Gemini 提取结构化数据，并处理返回结果。

**行动流程**:

**Step 1: 确定提取范围**

```
📋 Gemini 提取准备:

你的课程有多少周的教案？
→ 这决定了需要提取多少个数据文件

[用户输入: 16]

明白了！16 周课程。

你想要：
1. **逐个提取** (推荐首次使用)
   → 一次提取一周，我会实时验证
   → 发现问题立即修正
   
2. **批量提取** (推荐熟练用户)
   → 我一次性提供所有 Prompt
   → 你批量处理，效率最高

请选择 (1-2):
```

**Step 2: 提供定制化 Prompt**

**模式 A: 逐个提取**

```
好的！让我们从第 1 周开始。

📋 步骤：

1️⃣ 打开 Gemini: https://gemini.google.com

2️⃣ 上传第 1 周的教案文档

3️⃣ 复制并粘贴以下 Prompt:

┌──────────────────────────────────────────────
│ [自动生成 - 第 1 周提取 Prompt]
│
│ [使用 2.10 节的模板 2，动态替换 week_number = 1]
└──────────────────────────────────────────────

4️⃣ 等待 Gemini 处理（约 30-60 秒）

5️⃣ 将 Gemini 的完整回答复制粘贴给我

⏱️ 计时提示: 整个过程约 2-3 分钟

准备好了吗？(输入"开始"或直接粘贴结果)

当前状态: Gemini 辅助提取
```

**模式 B: 批量提取**

```
好的！我会为所有 16 周生成 Prompt。

📋 批量模式指南：

1️⃣ 准备工作
  - 打开 Gemini: https://gemini.google.com
  - 准备好所有 16 周的教案文档
  - 打开一个文本编辑器记录结果

2️⃣ 批量提取流程
  - 上传第 1 周文档 → 使用 Prompt 1 → 复制结果
  - 上传第 2 周文档 → 使用 Prompt 2 → 复制结果
  - ... 依次类推

3️⃣ 结果汇总
  - 将所有 16 个结果整理好
  - 一次性粘贴给我
  - 我会批量处理和验证

💡 专业提示：
  - 在 Google Docs 中记录结果，方便组织
  - 用分隔线区分不同周次
  - 标记好周次编号

准备好了吗？我现在为你生成所有 Prompt！

[生成 16 个 Prompt，每个标注清晰的周次]

当前状态: Gemini 辅助提取
```

**Step 3: 接收并处理数据**

```
[用户粘贴了 Gemini 的回答]

✅ 收到数据！让我处理一下...

🔄 处理进度:
  [1/5] 解析结构化数据... ✓ (检测到 {count} 周数据)
  [2/5] 转换为 YAML 格式... ✓
  [3/5] 检查 YAML 格式陷阱... 
        → 发现中文引号冲突 2 处 → 已自动修复 ✓
        → 检测数字类型 → 已添加引号 ✓
  [4/5] Schema 验证... ✓
  [5/5] 生成文件... ✓

📊 数据质量报告:

✅ 成功处理: {success_count} 个文件
  - lesson-01.yml ~ lesson-{success_count}.yml
  - 所有必需字段完整
  - 数据结构正确
  - 无格式陷阱

⚠️ 需要注意: {warning_count} 个
  [如果有警告，详细列出]

❌ 处理失败: {fail_count} 个
  [如果有失败，提供详细说明和修复建议]

📁 文件已保存到:
  → courses/{course_id}/lessons/

💡 接下来你可以：
  1. 查看生成的 YAML 文件
  2. 继续处理剩余数据（如果有）
  3. 开始生成 Word 文档

请选择 (1-3):

当前状态: Gemini 辅助提取
```

**状态转换**: 
- 数据处理完成且用户选择"生成文档" → `分析数据` (重新分析)
- 数据处理完成但需要查看/修改 → 保持当前状态或返回 `引导数据准备`
- 处理失败需要重新提取 → 保持 `Gemini 辅助提取` 状态

---
```

### 实施步骤

1. ✅ 紧跟"引导数据准备"状态添加
2. ✅ 提供逐个和批量两种模式
3. ✅ 包含完整的数据处理流程
4. ✅ 添加状态转换逻辑

### 验证标准

- [ ] 支持逐个和批量两种提取模式
- [ ] 自动处理常见的YAML格式陷阱
- [ ] 提供详细的数据质量报告
- [ ] 状态转换清晰合理

---

## 📝 Task 2.3: 增强"分析数据"状态

**优先级**: 🟡 P1 - 近期实施  
**位置**: 修改现有"分析数据"状态  
**预计时间**: 30 分钟

### 修改内容

**在现有"分析数据"状态中增强诊断能力：**

```markdown
### **`当前状态: 分析数据`** (v2.1 增强)

[保留现有内容]

[在"示例交互（目录为空）"之后添加]

**示例交互（数据不完整 - v2.1 增强）**:

```
✅ 成功读取课程配置: 字体设计基础

🔍 正在分析数据目录...
📂 数据目录: courses/course-001-字体设计基础/lessons/
📋 发现 12 个教案数据文件

⚠️ 数据完整性检查:

1. 文件数量不匹配
   - 课程配置: 16 周
   - 数据文件: 12 个
   - 缺失: 第 13-16 周的数据 (4 个文件)

2. 文件命名检查
   ✅ 所有文件命名规范 (lesson-XX.yml)
   ✅ 无重复编号
   ✅ 编号连续

3. 快速验证 (v2.1 新增)
   → 正在快速扫描文件头...
   ✅ lesson-01.yml: 基本字段完整
   ✅ lesson-02.yml: 基本字段完整
   ⚠️  lesson-05.yml: 可能缺少 lesson_title
   ✅ ...
   
💡 发现潜在问题:
   - lesson-05.yml 可能需要检查
   - 建议运行完整验证

🎯 我的建议:

方案 A: 补充缺失数据 ⭐ 推荐
  → 你有第 13-16 周的教案文档吗？
  → 有：使用 Gemini 提取（5分钟完成）
  → 没有：我提供模板，你手动创建
  
方案 B: 继续生成现有 12 个
  → 先完成已有部分
  → 后续再补充剩余 4 个
  → 注意：课程不完整，需要后续补充
  
方案 C: 修正课程配置
  → 更新 course.yml 中的 total_weeks 为 12
  → 适合：课程确实只有 12 周

方案 D: 先验证再决定
  → 完整验证所有 12 个文件
  → 修复发现的问题
  → 再决定如何处理缺失数据

💡 根据你的情况，我推荐:
   [AI 根据具体情况给出推荐，如：]
   → 如果你有 13-16 周文档：选 A（最快最好）
   → 如果暂时没有：选 B（分步完成）
   → 如果课程确实 12 周：选 C（修正配置）

你想选择哪个方案？(A/B/C/D)

当前状态: 分析数据
```

[其他示例交互保持不变]

**状态转换** (增强):
- 选择方案 A 且有文档 → `Gemini 辅助提取` 🆕
- 选择方案 A 且无文档 → `引导数据准备` 🆕
- 选择方案 B → `等待方案确认`
- 选择方案 C → 提供修改指导，保持 `分析数据` 状态
- 选择方案 D → `验证数据`
```

### 实施步骤

1. ✅ 找到现有"分析数据"状态
2. ✅ 在指定位置插入增强内容
3. ✅ 更新状态转换逻辑
4. ✅ 确保与新增状态的衔接

### 验证标准

- [ ] 提供了更详细的数据完整性检查
- [ ] 包含快速验证功能
- [ ] 提供了 4 种处理方案
- [ ] AI 能根据情况给出推荐
- [ ] 正确链接到新增状态

---

## 📝 Task 3.1: 增强验证错误解释

**优先级**: 🟢 P2 - 后续优化  
**位置**: 修改"验证数据"状态  
**预计时间**: 45 分钟

### 修改内容

**在"验证数据"状态的错误处理部分增强：**

```markdown
[在"示例交互（验证失败）"中增强错误解释]

**示例交互（验证失败 - v2.1 增强）**:

```
🔍 正在验证数据文件...

❌ 验证发现问题:
  ✅ 有效文件: 13 个
  ❌ 无效文件: 2 个

📋 详细错误分析:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
错误 #1: lesson-03.yml
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

❌ 缺少必需字段: lesson_title

📖 什么是 lesson_title?
   - 这是教案的标题（如"认识字体（上）"）
   - 它会显示在生成的 Word 文档标题位置
   - Schema 规定这是必需字段

🔧 如何修复:

方法 1: 手动添加 (推荐新手)
  1. 打开文件: lessons/lesson-03.yml
  2. 在文件顶部附近找到 lesson_number
  3. 在它下面添加一行:
     lesson_title: "第3课：你的标题"
  4. 保存文件

方法 2: 使用模板 (推荐熟练用户)
  复制这个完整示例:
  ┌─────────────────────────────
  │ lesson_number: "3"
  │ lesson_title: "第3课：字体的结构"  ← 添加这一行
  │ course_name: "字体设计基础"
  └─────────────────────────────

💡 需要参考？
   - 查看 Schema 定义: schemas/lesson_schema.yml
   - 参考其他文件: lessons/lesson-01.yml
   - 在线查看示例: [如果有文档链接]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
错误 #2: lesson-07.yml
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

❌ 字段类型错误: class_hours.total
   → 期望: 字符串 (string)
   → 实际: 数字 (integer)

📖 为什么必须是字符串?
   - Word 模板需要字符串格式
   - 方便添加单位（如 "4学时"）
   - Schema 规定此字段为 string 类型

🔧 如何修复:

  打开 lessons/lesson-07.yml，找到:
  ❌ class_hours:
       total: 4
  
  修改为:
  ✅ class_hours:
       total: "4"
  
  注意：就是在数字外面加引号！

⚠️ 常见错误提醒:
   这是 YAML 格式的常见陷阱 #2（数字类型错误）
   记住：lesson_number 和 class_hours.total 都必须加引号！

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 修复优先级建议:

  🔴 高优先级（必须修复）:
     - lesson-03.yml: 缺少必需字段

  🟡 中优先级（影响生成）:
     - lesson-07.yml: 类型错误（虽能生成但不规范）

💡 修复建议:
   
   快速修复（2 分钟）:
   1. 打开 lesson-03.yml，添加 lesson_title
   2. 打开 lesson-07.yml，给数字加引号
   3. 告诉我"已修复"，我会重新验证

   需要帮助？
   1. 让我生成修复后的完整示例
   2. 让我解释某个字段的用途
   3. 让我检查其他潜在问题

你想如何处理？
1. ✅ 我自己修复，完成后告诉你
2. 📝 请为我生成修复示例
3. ❓ 我需要更多帮助
4. ⏭️  跳过这些文件，只生成有效的 13 个

请选择 (1-4):

当前状态: 验证数据
```
```

### 实施步骤

1. ✅ 找到"验证数据"状态的错误处理部分
2. ✅ 替换为增强版的错误解释
3. ✅ 确保每个错误都有详细说明
4. ✅ 添加修复建议和优先级

### 验证标准

- [ ] 每个错误都有"是什么"的解释
- [ ] 提供了"如何修复"的步骤
- [ ] 包含完整的代码示例
- [ ] 提供了参考资源链接
- [ ] 有修复优先级建议

---

## 📝 Task 3.2: 添加快速诊断手册

**优先级**: 🟢 P2 - 后续优化  
**位置**: 在第 6 章末尾新增 6.4 节  
**预计时间**: 30 分钟

### 修改内容

**在第 6 章末尾添加：**

```markdown
### **6.4 快速诊断手册 (v2.1)** 🆕

#### **关键词查询系统**

用户可以随时输入关键词快速查询相关问题和解决方案。

**支持的关键词**:

| 关键词 | 匹配内容 |
|--------|----------|
| **格式问题** | 所有 Word 格式相关问题 |
| **占位符** | 占位符未替换问题 |
| **粗体** | 粗体格式相关问题 |
| **缩进** | 缩进、对齐问题 |
| **YAML** | YAML 格式错误 |
| **引号** | 引号冲突、嵌套问题 |
| **类型** | 数据类型错误 |
| **验证** | 验证失败相关问题 |
| **Gemini** | Gemini 提取相关问题 |

#### **查询响应模板**

**示例 1: 用户输入"格式问题"**

```
🔍 关键词匹配: "格式问题"

找到 5 个相关问题:

1. 📝 占位符前的粗体格式丢失 (FMT-001)
   状态: ✅ 已修复 (v2.1)
   
2. 🔤 替换内容错误继承格式 (FMT-002)
   状态: ✅ 已修复 (v2.1)
   
3. 📏 多行文本首行缩进丢失 (FMT-003)
   状态: ✅ 已修复 (v2.1)
   
4. 📝 占位符未被替换 (FMT-004)
   状态: ⚠️ 需检查数据
   
5. 🐛 出现代码残余文本 (FMT-005)
   状态: ✅ 已修复 (v2.0)

请输入问题编号查看详情（1-5），或输入 "全部" 查看所有问题。
```

**示例 2: 用户输入"占位符"**

```
🔍 关键词匹配: "占位符"

相关问题 #FMT-004: 占位符未被替换

📌 症状:
  - 生成的文档中还有 {{placeholder}}
  - 某些字段没有被填充

🔍 诊断流程:

第一步：检查数据完整性
  → 运行验证命令
  → 查找缺失字段

第二步：检查字段名匹配
  → 确认 YAML 中的键名与模板占位符一致
  → 注意大小写敏感

第三步：检查数组索引
  → 如果占位符使用索引（如 [0]）
  → 确认数据文件中有对应元素

💡 需要我运行诊断吗？(是/否)
```

**示例 3: 用户输入"YAML 引号"**

```
🔍 关键词匹配: "YAML + 引号"

这是 YAML 格式陷阱 #1: 中文引号冲突

⚠️ 这是最常见的错误（80% 的格式问题）！

📌 问题描述:
  YAML 使用 " 作为字符串分隔符
  如果内容中也有中文引号 ""，会导致解析错误

❌ 错误示例:
  value: "内容中有"中文引号"的文本"
        ↑ 这里会截断 ↑

✅ 正确写法:
  value: '内容中有"中文引号"的文本'
        ↑ 外层用单引号 ↑

🔧 快速修复:
  找到所有包含中文引号的字段
  → 将外层双引号改为单引号
  → 或去掉中文引号改用英文引号

需要我帮你检查文件中是否有这个问题吗？
```

#### **集成到状态机**

在任何状态下，如果用户输入以下内容，触发快速查询：
- 纯关键词（如"格式问题"）
- 疑问句包含关键词（如"为什么有格式问题"）
- 带"帮助"的请求（如"帮助 占位符"）

优先级：高于常规状态处理，立即响应查询
```

### 实施步骤

1. ✅ 在第 6 章末尾添加 6.4 节
2. ✅ 定义完整的关键词映射表
3. ✅ 提供查询响应模板
4. ✅ 说明如何集成到状态机

### 验证标准

- [ ] 关键词覆盖所有常见问题类型
- [ ] 每个查询都有清晰的响应模板
- [ ] 集成说明清晰可执行

---

## 📝 Task 3.3: 添加课程规划检查器

**优先级**: 🟢 P2 - 后续优化  
**位置**: 在"分析数据"状态中集成  
**预计时间**: 30 分钟

### 修改内容

**在"分析数据"状态的检查流程中添加：**

```markdown
[在数据分析完成后，添加课程规划检查]

**3. 课程规划合理性检查 (v2.1 新增)**

```
📊 课程规划检查:

课程配置:
  - 总周次: 16 周
  - 每周学时: 4 学时
  - 总学时: 64 学时

✅ 学时分配检查:

  1. 每周学时一致性
     ✅ 所有教案学时统一: 4 学时/周
     💡 符合最佳实践

  2. 章节学时分配
     正在分析各章节...
     
     第 1 章: 字体认知 (8 学时)
       ✅ 可整除: 8 ÷ 4 = 2 周
     
     第 2 章: 字体结构 (12 学时)
       ✅ 可整除: 12 ÷ 4 = 3 周
     
     第 3 章: 灯光技术 (10 学时)
       ⚠️ 不能整除: 10 ÷ 4 = 2.5 周
       → 需要跨周安排
     
     第 4 章: 综合实践 (34 学时)
       ✅ 可整除: 34 ÷ 4 = 8.5 周 → 但注意.5周

⚠️ 发现潜在问题:

问题 1: 第 3 章学时分配不规范
  - 章节学时: 10 学时
  - 问题: 不能被每周学时 (4) 整除
  - 影响: 需要跨周安排或调整内容

  💡 建议方案:
  
  方案 A: 拆分为 3 周（推荐）
    - 第 X 周: 4 学时（灯光基础）
    - 第 Y 周: 4 学时（高级技巧）
    - 第 Z 周: 2 学时（实践）+ 2 学时（其他章节内容）
  
  方案 B: 调整章节学时为 12
    - 增加 2 学时练习或拓展内容
    - 保持周次完整性
  
  方案 C: 调整为 8 学时
    - 精简部分内容
    - 标准 2 周完成

  你想采用哪个方案？(A/B/C/保持现状)

问题 2: 第 4 章学时较多
  - 章节学时: 34 学时
  - 占比: 53% 的总学时
  - 提示: 考虑是否需要拆分成多个小章节

  💡 这只是提示，不影响生成。
     大章节可能更适合综合性内容。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 检查总结:

  ✅ 通过检查: 3 项
  ⚠️ 需要注意: 2 项
  ❌ 严重问题: 0 项

💡 建议:
  - 课程整体结构合理
  - 建议处理第 3 章的学时分配问题
  - 第 4 章可以保持现状

继续生成？(是/调整后继续)
```
```

### 实施步骤

1. ✅ 在"分析数据"状态找到合适位置
2. ✅ 插入课程规划检查逻辑
3. ✅ 提供详细的检查项和建议
4. ✅ 确保不阻塞主流程

### 验证标准

- [ ] 检查每周学时一致性
- [ ] 检查章节学时合理性
- [ ] 提供具体的调整建议
- [ ] 不强制要求，仅作提示

---

## 📋 实施时间表

### Week 1: Phase 1 - 核心增强

| 任务 | 预计时间 | 负责人 | 状态 |
|------|----------|--------|------|
| Task 1.1 | 45 分钟 | - | ⬜ 待开始 |
| Task 1.2 | 1.5 小时 | - | ⬜ 待开始 |
| Task 1.3 | 1 小时 | - | ⬜ 待开始 |

### Week 2: Phase 2 - 状态机优化

| 任务 | 预计时间 | 负责人 | 状态 |
|------|----------|--------|------|
| Task 2.1 | 1 小时 | - | ⬜ 待开始 |
| Task 2.2 | 45 分钟 | - | ⬜ 待开始 |
| Task 2.3 | 30 分钟 | - | ⬜ 待开始 |

### Week 3: Phase 3 - 体验优化

| 任务 | 预计时间 | 负责人 | 状态 |
|------|----------|--------|------|
| Task 3.1 | 45 分钟 | - | ⬜ 待开始 |
| Task 3.2 | 30 分钟 | - | ⬜ 待开始 |
| Task 3.3 | 30 分钟 | - | ⬜ 待开始 |

---

## ✅ 验证清单

### 文档完整性

- [ ] 所有新增章节都有完整内容
- [ ] 所有示例代码格式正确
- [ ] 所有交互话术清晰易懂
- [ ] 章节编号正确无误

### 逻辑一致性

- [ ] 状态转换逻辑清晰
- [ ] 新旧状态衔接流畅
- [ ] 触发条件明确无歧义
- [ ] 跨章节引用正确

### 实战验证

- [ ] 使用实际场景测试 Gemini 工作流
- [ ] 验证 YAML 陷阱预警的有效性
- [ ] 测试格式问题诊断的准确性
- [ ] 确认所有话术符合实际使用

---

## 📊 预期成果

实施完成后，lesson-weaver.md 将：

1. **篇幅增加约 40%**
   - 从 ~1,200 行 → ~1,700 行
   - 新增 3 个主要章节
   - 新增 2 个状态定义

2. **功能提升显著**
   - ✅ 支持 Gemini 集成（节省 80% Token）
   - ✅ 主动预警 YAML 陷阱（减少 80% 格式错误）
   - ✅ 智能诊断格式问题（减少 80% 诊断时间）
   - ✅ 增强验证错误解释（提升 100% 可操作性）

3. **用户体验优化**
   - 新手用户独立完成率: 30% → 80%
   - 平均完成时间: 减少 50%
   - 错误发生率: 减少 70%

---

## 🚀 开始实施

**推荐实施顺序**:

1. ✅ **先实施 Task 1.1** (YAML 陷阱预警)
   - 影响最大
   - 实施最简单
   - 立即见效

2. ✅ **然后 Task 1.2** (Gemini 集成)
   - 核心功能
   - 用户需求强
   - 显著提升效率

3. ✅ **接着 Task 1.3** (格式诊断)
   - 解决痛点
   - 提升满意度

4. ✅ **最后其他 Task** (状态优化和体验提升)
   - 锦上添花
   - 逐步完善

---

**准备好了吗？让我们从 Task 1.1 开始！** 🚀

*文档结束*

**版本**: v2.1 实施计划  
**创建日期**: 2025-10-05  
**预计完成**: 2025-10-12  
**维护者**: @architect.mdc
